image: python:3.11
definitions:
  services:
    redis:
      image: redis
    broker:
      image: rabbitmq:3
      ports:
        - 5672:5672
  steps:
    - step: &lint
        caches:
          - pip
        name: Lint
        script:
          - echo "Retrieving and Executing Lint Script"
          - curl -fL https://getcli.jfrog.io | sh
          - ./jfrog rt dl --url $ARTIFACTORY_URL --user $ARTIFACTORY_USER --password $ARTIFACTORY_PASSWORD generic-packages/ci_scripts/latest/lint_python.sh
          - cat ci_scripts/latest/lint_python.sh
          - chmod 755 ci_scripts/latest/lint_python.sh
          - ./ci_scripts/latest/lint_python.sh
    - step: &changelog
        caches:
          - pip
        name: Changelog
        script:
          - pip install -U pip
          - pip install towncrier
          # We need to fetch the main branch to compare against
          - git remote set-branches --add origin main
          - git fetch origin main
          - towncrier check --compare-with origin/main
    - step: &scan
        caches:
          - pip
        name: Scan
        script:
          - echo "Retrieving and Executing Scan Script"
          - curl -fL https://getcli.jfrog.io | sh
          - ./jfrog rt dl --url $ARTIFACTORY_URL --user $ARTIFACTORY_USER --password $ARTIFACTORY_PASSWORD generic-packages/ci_scripts/latest/scan_python.sh
          - cat ci_scripts/latest/scan_python.sh
          - chmod 755 ci_scripts/latest/scan_python.sh
          - ./ci_scripts/latest/scan_python.sh
    - step: &test
        caches:
          - pip
        name: Test
        script:
          - pip install -U pip
          - pip install .[test]
          - pytest -v -n auto -m "not development" --cov dkist_processing_common
        services:
          - redis
          - broker
        size: 2x
    - step: &push
        caches:
          - pip
        name: Push
        script:
          - pip install -U pip
          - pip install build twine
          - python -m build --outdir wheelhouse .
          - python -m twine upload --skip-existing wheelhouse/*
    - step: &docs
        name: Test Docs
        caches:
          - pip
        script:
          - pip install -U pip
          - apt update && apt -y install graphviz
          - pip install .[docs]
          - sphinx-build --color -W --keep-going -b html docs docs/_build/html
    - step: &check_changelog
        name: Check for updated CHANGELOG
        script:
          - ./check_changelog_updated.sh

pipelines:
  default:
    - parallel:
      - step: *lint
      - step: *changelog
    - parallel:
      - step: *scan
      - step: *test
      - step: *docs
  custom:
    skip_doc_test_to_build_rc:  # I.e. skip the doc check (because we might have rc dependencies)
      - variables:
        - name: BITBUCKET_TAG
          description: "Tag version to build (e.g., 'vX.Y.ZrcR')"
      - step:
          name: Validate Bitbucket pipeline input
          script:
            - git tag | grep -q ${BITBUCKET_TAG} || { echo Tag ${BITBUCKET_TAG} not found!; exit 1; }
            - echo ${BITBUCKET_TAG} | grep -q "rc[0-9]\+$" || { echo Tag ${BITBUCKET_TAG} is not an rc. SHAME!; exit 1; }
      - parallel:
        - step: *changelog
        - step: *lint
      - parallel:
        - step: *scan
        - step: *test
      - step: *push
  tags:
    'v*':
      - parallel:
        - step: *check_changelog
        - step: *lint
      - parallel:
        - step: *scan
        - step: *test
        - step: *docs
      - step: *push
