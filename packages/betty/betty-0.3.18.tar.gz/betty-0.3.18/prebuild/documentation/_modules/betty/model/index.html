<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="author" title="About these documents" href="../../../about/" /><link rel="index" title="Index" href="../../../genindex/" /><link rel="search" title="Search" href="../../../search/" />

    <link rel="shortcut icon" href="../../../_static/betty.ico"/><!-- Generated with Sphinx 7.4.7 and Furo 2024.05.06 -->
        <title>betty.model - Betty documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=387cc868" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" /
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../"><div class="brand">Betty  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../_static/betty-32x32.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Betty  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search/" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../installation/">Installation</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Installation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../installation/desktop/">Installation of the Betty Desktop application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation/pip/">Installation via <code class="docutils literal notranslate"><span class="pre">pip</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation/source/">Installation from source</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../usage/">Usage</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Usage</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../usage/ancestry/">Ancestry</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Ancestry</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/citation/">Citation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/date/">Dates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/enclosure/">Enclosure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/event/">Event</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/event-type/">Event Type</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/file/">File</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/link/">Link</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/media-type/">Media Type</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/note/">Note</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/person/">Person</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/person-name/">Person Name</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/place/">Place</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/place-name/">Place Name</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/presence/">Presence</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/presence-role/">Presence Role</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/privacy/">Privacy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/ancestry/source/">Source</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/assets/">Asset Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/cli/">The command line</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/configuration/">Application configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/env/">Environment variables</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../usage/extension/">Extensions</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Extensions</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/extension/cotton_candy/">The <em>Cotton Candy</em> extension</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/extension/deriver/">The <em>Deriver</em> extension</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/extension/gramps/">The <em>Gramps</em> extension</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/extension/http_api_doc/">The <em>HTTP API Documentation</em> extension</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/extension/maps/">The <em>Maps</em> extension</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/extension/nginx/">The <em>nginx</em> extension</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/extension/privatizer/">The <em>Privatizer</em> extension</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/extension/trees/">The <em>Trees</em> extension</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/extension/wikipedia/">The <em>Wikipedia</em> extension</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/gedcom/">GEDCOM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/npm/">npm</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../usage/project/">Projects</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Projects</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/project/configuration/">Project configuration</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../usage/templating/">Templating</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Templating</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/templating/filters/">Filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/templating/globals/">Globals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../usage/templating/tests/">Tests</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/translation/">Translations</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../development/">Development</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Development</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../development/extension/">Developing a Betty extension</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../development/translation/">Working on Betty’s translations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../development/test/">Testing Betty’s source code</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../py-modindex/">API Documentation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../about/">About</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of About</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../about/contributing/">Contributing to Betty</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about/license/">Copyright &amp; license</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for betty.model</h1><div class="highlight"><pre>
<span></span>&quot;&quot;&quot;Provide Betty&#39;s data model API.&quot;&quot;&quot;

from __future__ import annotations

import functools
import weakref
from collections import defaultdict
from contextlib import contextmanager
from reprlib import recursive_repr
from typing import (
    TypeVar,
    Generic,
    Iterable,
    Any,
    overload,
    cast,
    Iterator,
    Callable,
    Self,
    TypeAlias,
    TYPE_CHECKING,
)
from uuid import uuid4

from typing_extensions import override

from betty.classtools import repr_instance
from betty.functools import Uniquifier
from betty.importlib import import_any, fully_qualified_type_name
from betty.json.linked_data import LinkedDataDumpable, add_json_ld
from betty.json.schema import ref_json_schema
from betty.locale import Str
from betty.string import camel_case_to_kebab_case, upper_camel_case_to_lower_camel_case

if TYPE_CHECKING:
    from betty.serde.dump import DictDump, Dump
    import builtins
    from betty.app import App


T = TypeVar(&quot;T&quot;)


<div class="viewcode-block" id="GeneratedEntityId">
<a class="viewcode-back" href="../../../betty.model/#betty.model.GeneratedEntityId">[docs]</a>
class GeneratedEntityId(str):
    &quot;&quot;&quot;
    Generate a unique entity ID.

    Entities must have IDs for identification. However, not all entities can be provided with an ID that exists in the
    original data set (such as a third-party family tree loaded into Betty), so IDs can be generated.
    &quot;&quot;&quot;

    __slots__ = ()

<div class="viewcode-block" id="GeneratedEntityId.__new__">
<a class="viewcode-back" href="../../../betty.model/#betty.model.GeneratedEntityId.__new__">[docs]</a>
    def __new__(cls, entity_id: str | None = None):  # noqa D102
        return super().__new__(cls, entity_id or str(uuid4()))</div>
</div>



<div class="viewcode-block" id="Entity">
<a class="viewcode-back" href="../../../betty.model/#betty.model.Entity">[docs]</a>
class Entity(LinkedDataDumpable):
    &quot;&quot;&quot;
    An entity is a uniquely identifiable data container.
    &quot;&quot;&quot;

<div class="viewcode-block" id="Entity.__init__">
<a class="viewcode-back" href="../../../betty.model/#betty.model.Entity.__init__">[docs]</a>
    def __init__(
        self,
        id: str | None = None,  # noqa A002
        *args: Any,
        **kwargs: Any,
    ):
        self._id = GeneratedEntityId() if id is None else id
        super().__init__(*args, **kwargs)</div>


    def __hash__(self) -&gt; int:
        return hash(self.ancestry_id)

<div class="viewcode-block" id="Entity.entity_type_label">
<a class="viewcode-back" href="../../../betty.model/#betty.model.Entity.entity_type_label">[docs]</a>
    @classmethod
    def entity_type_label(cls) -&gt; Str:
        &quot;&quot;&quot;
        The human-readable entity type label, singular.
        &quot;&quot;&quot;
        raise NotImplementedError(repr(cls))</div>


<div class="viewcode-block" id="Entity.entity_type_label_plural">
<a class="viewcode-back" href="../../../betty.model/#betty.model.Entity.entity_type_label_plural">[docs]</a>
    @classmethod
    def entity_type_label_plural(cls) -&gt; Str:
        &quot;&quot;&quot;
        The human-readable entity type label, plural.
        &quot;&quot;&quot;
        raise NotImplementedError(repr(cls))</div>


    @override  # type: ignore[callable-functiontype]
    @recursive_repr()
    def __repr__(self) -&gt; str:
        return repr_instance(self, id=self._id)

    @property
    def type(self) -&gt; builtins.type[Self]:
        &quot;&quot;&quot;
        The entity type.
        &quot;&quot;&quot;
        return self.__class__

    @property
    def id(self) -&gt; str:
        &quot;&quot;&quot;
        The entity ID.

        This MUST be unique per entity type, per ancestry.
        &quot;&quot;&quot;
        return self._id

    @property
    def ancestry_id(self) -&gt; tuple[builtins.type[Self], str]:
        &quot;&quot;&quot;
        The ancestry ID.

        This MUST be unique per ancestry.
        &quot;&quot;&quot;
        return self.type, self.id

    @property
    def label(self) -&gt; Str:
        &quot;&quot;&quot;
        The entity&#39;s human-readable label.
        &quot;&quot;&quot;
        return Str._(
            &quot;{entity_type} {entity_id}&quot;,
            entity_type=self.entity_type_label(),
            entity_id=self.id,
        )

<div class="viewcode-block" id="Entity.dump_linked_data">
<a class="viewcode-back" href="../../../betty.model/#betty.model.Entity.dump_linked_data">[docs]</a>
    @override
    async def dump_linked_data(self, app: App) -&gt; DictDump[Dump]:
        dump = await super().dump_linked_data(app)

        entity_type_name = get_entity_type_name(self.type)
        dump[&quot;$schema&quot;] = app.static_url_generator.generate(
            f&quot;schema.json#/definitions/entity/{upper_camel_case_to_lower_camel_case(entity_type_name)}&quot;,
            absolute=True,
        )

        if not isinstance(self.id, GeneratedEntityId):
            dump[&quot;@id&quot;] = app.static_url_generator.generate(
                f&quot;/{camel_case_to_kebab_case(entity_type_name)}/{self.id}/index.json&quot;,
                absolute=True,
            )
            dump[&quot;id&quot;] = self.id

        return dump</div>


<div class="viewcode-block" id="Entity.linked_data_schema">
<a class="viewcode-back" href="../../../betty.model/#betty.model.Entity.linked_data_schema">[docs]</a>
    @override
    @classmethod
    async def linked_data_schema(cls, app: App) -&gt; DictDump[Dump]:
        schema = await super().linked_data_schema(app)
        schema[&quot;type&quot;] = &quot;object&quot;
        schema[&quot;properties&quot;] = {
            &quot;$schema&quot;: ref_json_schema(schema),
            &quot;id&quot;: {
                &quot;type&quot;: &quot;string&quot;,
            },
        }
        schema[&quot;required&quot;] = [
            &quot;$schema&quot;,
        ]
        schema[&quot;additionalProperties&quot;] = False
        add_json_ld(schema)
        return schema</div>
</div>



AncestryEntityId: TypeAlias = tuple[type[Entity], str]


<div class="viewcode-block" id="UserFacingEntity">
<a class="viewcode-back" href="../../../betty.model/#betty.model.UserFacingEntity">[docs]</a>
class UserFacingEntity:
    &quot;&quot;&quot;
    A sentinel to mark an entity type as being visible to users (e.g. not internal).
    &quot;&quot;&quot;

    pass</div>



<div class="viewcode-block" id="EntityTypeProvider">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityTypeProvider">[docs]</a>
class EntityTypeProvider:
    &quot;&quot;&quot;
    Provide additional entity types.
    &quot;&quot;&quot;

<div class="viewcode-block" id="EntityTypeProvider.entity_types">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityTypeProvider.entity_types">[docs]</a>
    async def entity_types(self) -&gt; set[type[Entity]]:
        &quot;&quot;&quot;
        The entity types.
        &quot;&quot;&quot;
        raise NotImplementedError(repr(self))</div>
</div>



EntityT = TypeVar(&quot;EntityT&quot;, bound=Entity)
EntityU = TypeVar(&quot;EntityU&quot;, bound=Entity)
TargetT = TypeVar(&quot;TargetT&quot;)
OwnerT = TypeVar(&quot;OwnerT&quot;)
AssociateT = TypeVar(&quot;AssociateT&quot;)
AssociateU = TypeVar(&quot;AssociateU&quot;)
LeftAssociateT = TypeVar(&quot;LeftAssociateT&quot;)
RightAssociateT = TypeVar(&quot;RightAssociateT&quot;)


<div class="viewcode-block" id="get_entity_type_name">
<a class="viewcode-back" href="../../../betty.model/#betty.model.get_entity_type_name">[docs]</a>
def get_entity_type_name(entity_type_definition: type[Entity] | Entity) -&gt; str:
    &quot;&quot;&quot;
    Get the entity type name for an entity or entity type.
    &quot;&quot;&quot;
    if isinstance(entity_type_definition, Entity):
        entity_type = entity_type_definition.type
    else:
        entity_type = entity_type_definition

    if entity_type.__module__.startswith(&quot;betty.model.ancestry&quot;):
        return entity_type.__name__
    return f&quot;{entity_type.__module__}.{entity_type.__name__}&quot;</div>



<div class="viewcode-block" id="get_entity_type">
<a class="viewcode-back" href="../../../betty.model/#betty.model.get_entity_type">[docs]</a>
def get_entity_type(entity_type_name: str) -&gt; type[Entity]:
    &quot;&quot;&quot;
    Get the entity type for an entity type name.
    &quot;&quot;&quot;
    try:
        return import_any(entity_type_name)  # type: ignore[no-any-return]
    except ImportError:
        try:
            return import_any(f&quot;betty.model.ancestry.{entity_type_name}&quot;)  # type: ignore[no-any-return]
        except ImportError:
            raise EntityTypeImportError(entity_type_name) from None</div>



<div class="viewcode-block" id="EntityTypeError">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityTypeError">[docs]</a>
class EntityTypeError(ValueError):
    &quot;&quot;&quot;
    A error occurred when trying to determine and import an entity type.
    &quot;&quot;&quot;

    pass</div>



<div class="viewcode-block" id="EntityTypeImportError">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityTypeImportError">[docs]</a>
class EntityTypeImportError(EntityTypeError, ImportError):
    &quot;&quot;&quot;
    Raised when an alleged entity type cannot be imported.
    &quot;&quot;&quot;

<div class="viewcode-block" id="EntityTypeImportError.__init__">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityTypeImportError.__init__">[docs]</a>
    def __init__(self, entity_type_name: str):
        super().__init__(
            f&#39;Cannot find and import an entity with name &quot;{entity_type_name}&quot;.&#39;
        )</div>
</div>



<div class="viewcode-block" id="EntityTypeInvalidError">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityTypeInvalidError">[docs]</a>
class EntityTypeInvalidError(EntityTypeError, ImportError):
    &quot;&quot;&quot;
    Raised for types that are not valid entity types.
    &quot;&quot;&quot;

<div class="viewcode-block" id="EntityTypeInvalidError.__init__">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityTypeInvalidError.__init__">[docs]</a>
    def __init__(self, entity_type: type):
        super().__init__(
            f&quot;{entity_type.__module__}.{entity_type.__name__} is not an entity type class. Entity types must extend {Entity.__module__}.{Entity.__name__} directly.&quot;
        )</div>
</div>



<div class="viewcode-block" id="EntityCollection">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityCollection">[docs]</a>
class EntityCollection(Generic[TargetT]):
    &quot;&quot;&quot;
    Provide a collection of entities.
    &quot;&quot;&quot;

    __slots__ = ()

<div class="viewcode-block" id="EntityCollection.__init__">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityCollection.__init__">[docs]</a>
    def __init__(self):
        super().__init__()</div>


    def _on_add(self, *entities: TargetT &amp; Entity) -&gt; None:
        pass

    def _on_remove(self, *entities: TargetT &amp; Entity) -&gt; None:
        pass

    @property
    def view(self) -&gt; list[TargetT &amp; Entity]:
        &quot;&quot;&quot;
        A view of the entities at the time of calling.
        &quot;&quot;&quot;
        return [*self]

<div class="viewcode-block" id="EntityCollection.add">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityCollection.add">[docs]</a>
    def add(self, *entities: TargetT &amp; Entity) -&gt; None:
        &quot;&quot;&quot;
        Add the given entities.
        &quot;&quot;&quot;
        raise NotImplementedError(repr(self))</div>


<div class="viewcode-block" id="EntityCollection.remove">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityCollection.remove">[docs]</a>
    def remove(self, *entities: TargetT &amp; Entity) -&gt; None:
        &quot;&quot;&quot;
        Remove the given entities.
        &quot;&quot;&quot;
        raise NotImplementedError(repr(self))</div>


<div class="viewcode-block" id="EntityCollection.replace">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityCollection.replace">[docs]</a>
    def replace(self, *entities: TargetT &amp; Entity) -&gt; None:
        &quot;&quot;&quot;
        Replace all entities with the given ones.
        &quot;&quot;&quot;
        self.remove(*(entity for entity in self if entity not in entities))
        self.add(*entities)</div>


<div class="viewcode-block" id="EntityCollection.clear">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityCollection.clear">[docs]</a>
    def clear(self) -&gt; None:
        &quot;&quot;&quot;
        Clear all entities from the collection.
        &quot;&quot;&quot;
        raise NotImplementedError(repr(self))</div>


    def __iter__(self) -&gt; Iterator[TargetT &amp; Entity]:
        raise NotImplementedError(repr(self))

    def __len__(self) -&gt; int:
        raise NotImplementedError(repr(self))

    @overload
    def __getitem__(self, index: int) -&gt; TargetT &amp; Entity:
        pass

    @overload
    def __getitem__(self, indices: slice) -&gt; list[TargetT &amp; Entity]:
        pass

    def __getitem__(
        self, key: int | slice
    ) -&gt; TargetT &amp; Entity | list[TargetT &amp; Entity]:
        raise NotImplementedError(repr(self))

    def __delitem__(self, key: TargetT &amp; Entity) -&gt; None:
        raise NotImplementedError(repr(self))

    def __contains__(self, value: Any) -&gt; bool:
        raise NotImplementedError(repr(self))

    def _known(self, *entities: TargetT &amp; Entity) -&gt; Iterable[TargetT &amp; Entity]:
        for entity in Uniquifier(entities):
            if entity in self:
                yield entity

    def _unknown(self, *entities: TargetT &amp; Entity) -&gt; Iterable[TargetT &amp; Entity]:
        for entity in Uniquifier(entities):
            if entity not in self:
                yield entity</div>



EntityCollectionT = TypeVar(&quot;EntityCollectionT&quot;, bound=EntityCollection[EntityT])


class _EntityTypeAssociation(Generic[OwnerT, AssociateT]):
    def __init__(
        self,
        owner_type: type[OwnerT],
        owner_attr_name: str,
        associate_type_name: str,
    ):
        self._owner_type = owner_type
        self._owner_attr_name = owner_attr_name
        self._owner_private_attr_name = f&quot;_{owner_attr_name}&quot;
        self._associate_type_name = associate_type_name
        self._associate_type: type[AssociateT] | None = None

    def __hash__(self) -&gt; int:
        return hash(
            (
                self._owner_type,
                self._owner_attr_name,
                self._associate_type_name,
            )
        )

    @override
    def __repr__(self) -&gt; str:
        return repr_instance(
            self,
            owner_type=self._owner_type,
            owner_attr_name=self._owner_attr_name,
            associate_type_name=self._associate_type_name,
        )

    @property
    def owner_type(self) -&gt; type[OwnerT]:
        return self._owner_type

    @property
    def owner_attr_name(self) -&gt; str:
        return self._owner_attr_name

    @property
    def associate_type(self) -&gt; type[AssociateT]:
        if self._associate_type is None:
            self._associate_type = import_any(self._associate_type_name)
        return self._associate_type

    def register(self: ToAny[OwnerT, AssociateT]) -&gt; None:
        EntityTypeAssociationRegistry._register(self)

        original_init = self._owner_type.__init__

        @functools.wraps(original_init)
        def _init(owner: OwnerT &amp; Entity, *args: Any, **kwargs: Any) -&gt; None:
            self.initialize(owner)
            original_init(owner, *args, **kwargs)

        self._owner_type.__init__ = _init  # type: ignore[assignment, method-assign]

    def initialize(self, owner: OwnerT &amp; Entity) -&gt; None:
        raise NotImplementedError(repr(self))

    def finalize(self, owner: OwnerT &amp; Entity) -&gt; None:
        self.delete(owner)
        delattr(owner, self._owner_private_attr_name)

    def delete(self, owner: OwnerT &amp; Entity) -&gt; None:
        raise NotImplementedError(repr(self))

    def associate(self, owner: OwnerT &amp; Entity, associate: AssociateT &amp; Entity) -&gt; None:
        raise NotImplementedError(repr(self))

    def disassociate(
        self, owner: OwnerT &amp; Entity, associate: AssociateT &amp; Entity
    ) -&gt; None:
        raise NotImplementedError(repr(self))


<div class="viewcode-block" id="BidirectionalEntityTypeAssociation">
<a class="viewcode-back" href="../../../betty.model/#betty.model.BidirectionalEntityTypeAssociation">[docs]</a>
class BidirectionalEntityTypeAssociation(
    Generic[OwnerT, AssociateT], _EntityTypeAssociation[OwnerT, AssociateT]
):
    &quot;&quot;&quot;
    A bidirectional entity type association.
    &quot;&quot;&quot;

<div class="viewcode-block" id="BidirectionalEntityTypeAssociation.__init__">
<a class="viewcode-back" href="../../../betty.model/#betty.model.BidirectionalEntityTypeAssociation.__init__">[docs]</a>
    def __init__(
        self,
        owner_type: type[OwnerT],
        owner_attr_name: str,
        associate_type_name: str,
        associate_attr_name: str,
    ):
        super().__init__(
            owner_type,
            owner_attr_name,
            associate_type_name,
        )
        self._associate_attr_name = associate_attr_name</div>


    def __hash__(self) -&gt; int:
        return hash(
            (
                self._owner_type,
                self._owner_attr_name,
                self._associate_type_name,
                self._associate_attr_name,
            )
        )

    @override
    def __repr__(self) -&gt; str:
        return repr_instance(
            self,
            owner_type=self._owner_type,
            owner_attr_name=self._owner_attr_name,
            associate_type_name=self._associate_type_name,
            associate_attr_name=self._associate_attr_name,
        )

    @property
    def associate_attr_name(self) -&gt; str:
        &quot;&quot;&quot;
        The association&#39;s attribute name on the associate type.
        &quot;&quot;&quot;
        return self._associate_attr_name

<div class="viewcode-block" id="BidirectionalEntityTypeAssociation.inverse">
<a class="viewcode-back" href="../../../betty.model/#betty.model.BidirectionalEntityTypeAssociation.inverse">[docs]</a>
    def inverse(self) -&gt; BidirectionalEntityTypeAssociation[AssociateT, OwnerT]:
        &quot;&quot;&quot;
        Get the inverse association.
        &quot;&quot;&quot;
        association = EntityTypeAssociationRegistry.get_association(
            self.associate_type, self.associate_attr_name
        )
        assert isinstance(association, BidirectionalEntityTypeAssociation)
        return association</div>
</div>



<div class="viewcode-block" id="ToOneEntityTypeAssociation">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToOneEntityTypeAssociation">[docs]</a>
class ToOneEntityTypeAssociation(
    Generic[OwnerT, AssociateT], _EntityTypeAssociation[OwnerT, AssociateT]
):
    &quot;&quot;&quot;
    A unidirectional to-one entity type association.
    &quot;&quot;&quot;

<div class="viewcode-block" id="ToOneEntityTypeAssociation.register">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToOneEntityTypeAssociation.register">[docs]</a>
    @override
    def register(self) -&gt; None:
        super().register()
        setattr(
            self.owner_type,
            self.owner_attr_name,
            property(
                self.get,
                self.set,
                self.delete,
            ),
        )</div>


<div class="viewcode-block" id="ToOneEntityTypeAssociation.initialize">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToOneEntityTypeAssociation.initialize">[docs]</a>
    @override
    def initialize(self, owner: OwnerT &amp; Entity) -&gt; None:
        setattr(owner, self._owner_private_attr_name, None)</div>


<div class="viewcode-block" id="ToOneEntityTypeAssociation.get">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToOneEntityTypeAssociation.get">[docs]</a>
    def get(self, owner: OwnerT &amp; Entity) -&gt; AssociateT &amp; Entity | None:
        &quot;&quot;&quot;
        Get the associate from the given owner.
        &quot;&quot;&quot;
        return getattr(owner, self._owner_private_attr_name)  # type: ignore[return-value]</div>


<div class="viewcode-block" id="ToOneEntityTypeAssociation.set">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToOneEntityTypeAssociation.set">[docs]</a>
    def set(
        self, owner: OwnerT &amp; Entity, associate: AssociateT &amp; Entity | None
    ) -&gt; None:
        &quot;&quot;&quot;
        Set the associate for the given owner.
        &quot;&quot;&quot;
        setattr(owner, self._owner_private_attr_name, associate)</div>


<div class="viewcode-block" id="ToOneEntityTypeAssociation.delete">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToOneEntityTypeAssociation.delete">[docs]</a>
    @override
    def delete(self, owner: OwnerT &amp; Entity) -&gt; None:
        self.set(owner, None)</div>


<div class="viewcode-block" id="ToOneEntityTypeAssociation.associate">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToOneEntityTypeAssociation.associate">[docs]</a>
    @override
    def associate(self, owner: OwnerT &amp; Entity, associate: AssociateT &amp; Entity) -&gt; None:
        self.set(owner, associate)</div>


<div class="viewcode-block" id="ToOneEntityTypeAssociation.disassociate">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToOneEntityTypeAssociation.disassociate">[docs]</a>
    @override
    def disassociate(
        self, owner: OwnerT &amp; Entity, associate: AssociateT &amp; Entity
    ) -&gt; None:
        if associate == self.get(owner):
            self.delete(owner)</div>
</div>



<div class="viewcode-block" id="ToManyEntityTypeAssociation">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToManyEntityTypeAssociation">[docs]</a>
class ToManyEntityTypeAssociation(
    Generic[OwnerT, AssociateT], _EntityTypeAssociation[OwnerT, AssociateT]
):
    &quot;&quot;&quot;
    A to-many entity type association.
    &quot;&quot;&quot;

<div class="viewcode-block" id="ToManyEntityTypeAssociation.register">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToManyEntityTypeAssociation.register">[docs]</a>
    @override
    def register(self) -&gt; None:
        super().register()
        setattr(
            self.owner_type,
            self.owner_attr_name,
            property(
                self.get,
                self.set,
                self.delete,
            ),
        )</div>


<div class="viewcode-block" id="ToManyEntityTypeAssociation.get">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToManyEntityTypeAssociation.get">[docs]</a>
    def get(self, owner: OwnerT &amp; Entity) -&gt; EntityCollection[AssociateT &amp; Entity]:
        &quot;&quot;&quot;
        Get the associates from the given owner.
        &quot;&quot;&quot;
        return cast(
            EntityCollection[&quot;AssociateT &amp; Entity&quot;],
            getattr(owner, self._owner_private_attr_name),
        )</div>


<div class="viewcode-block" id="ToManyEntityTypeAssociation.set">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToManyEntityTypeAssociation.set">[docs]</a>
    def set(
        self, owner: OwnerT &amp; Entity, entities: Iterable[AssociateT &amp; Entity]
    ) -&gt; None:
        &quot;&quot;&quot;
        Set the associates on the given owner.
        &quot;&quot;&quot;
        self.get(owner).replace(*entities)</div>


<div class="viewcode-block" id="ToManyEntityTypeAssociation.delete">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToManyEntityTypeAssociation.delete">[docs]</a>
    @override
    def delete(self, owner: OwnerT &amp; Entity) -&gt; None:
        self.get(owner).clear()</div>


<div class="viewcode-block" id="ToManyEntityTypeAssociation.associate">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToManyEntityTypeAssociation.associate">[docs]</a>
    @override
    def associate(self, owner: OwnerT &amp; Entity, associate: AssociateT &amp; Entity) -&gt; None:
        self.get(owner).add(associate)</div>


<div class="viewcode-block" id="ToManyEntityTypeAssociation.disassociate">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToManyEntityTypeAssociation.disassociate">[docs]</a>
    @override
    def disassociate(
        self, owner: OwnerT &amp; Entity, associate: AssociateT &amp; Entity
    ) -&gt; None:
        self.get(owner).remove(associate)</div>
</div>



<div class="viewcode-block" id="BidirectionalToOneEntityTypeAssociation">
<a class="viewcode-back" href="../../../betty.model/#betty.model.BidirectionalToOneEntityTypeAssociation">[docs]</a>
class BidirectionalToOneEntityTypeAssociation(
    Generic[OwnerT, AssociateT],
    ToOneEntityTypeAssociation[OwnerT, AssociateT],
    BidirectionalEntityTypeAssociation[OwnerT, AssociateT],
):
    &quot;&quot;&quot;
    A bidirectional *-to-one entity type association.
    &quot;&quot;&quot;

<div class="viewcode-block" id="BidirectionalToOneEntityTypeAssociation.set">
<a class="viewcode-back" href="../../../betty.model/#betty.model.BidirectionalToOneEntityTypeAssociation.set">[docs]</a>
    @override
    def set(
        self, owner: OwnerT &amp; Entity, associate: AssociateT &amp; Entity | None
    ) -&gt; None:
        previous_associate = self.get(owner)
        if previous_associate == associate:
            return
        super().set(owner, associate)
        if previous_associate is not None:
            self.inverse().disassociate(previous_associate, owner)
        if associate is not None:
            self.inverse().associate(associate, owner)</div>
</div>



<div class="viewcode-block" id="BidirectionalToManyEntityTypeAssociation">
<a class="viewcode-back" href="../../../betty.model/#betty.model.BidirectionalToManyEntityTypeAssociation">[docs]</a>
class BidirectionalToManyEntityTypeAssociation(
    Generic[OwnerT, AssociateT],
    ToManyEntityTypeAssociation[OwnerT, AssociateT],
    BidirectionalEntityTypeAssociation[OwnerT, AssociateT],
):
    &quot;&quot;&quot;
    A bidirectional *-to-many entity type association.
    &quot;&quot;&quot;

<div class="viewcode-block" id="BidirectionalToManyEntityTypeAssociation.initialize">
<a class="viewcode-back" href="../../../betty.model/#betty.model.BidirectionalToManyEntityTypeAssociation.initialize">[docs]</a>
    @override
    def initialize(self, owner: OwnerT &amp; Entity) -&gt; None:
        setattr(
            owner,
            self._owner_private_attr_name,
            _BidirectionalAssociateCollection(
                owner,
                self,
            ),
        )</div>
</div>



<div class="viewcode-block" id="ToOne">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToOne">[docs]</a>
class ToOne(
    Generic[OwnerT, AssociateT], ToOneEntityTypeAssociation[OwnerT, AssociateT]
):
    &quot;&quot;&quot;
    A unidirectional to-one entity type association.
    &quot;&quot;&quot;

    pass</div>



<div class="viewcode-block" id="OneToOne">
<a class="viewcode-back" href="../../../betty.model/#betty.model.OneToOne">[docs]</a>
class OneToOne(
    Generic[OwnerT, AssociateT],
    BidirectionalToOneEntityTypeAssociation[OwnerT, AssociateT],
):
    &quot;&quot;&quot;
    A bidirectional one-to-one entity type association.
    &quot;&quot;&quot;

    pass</div>



<div class="viewcode-block" id="ManyToOne">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ManyToOne">[docs]</a>
class ManyToOne(
    Generic[OwnerT, AssociateT],
    BidirectionalToOneEntityTypeAssociation[OwnerT, AssociateT],
):
    &quot;&quot;&quot;
    A bidirectional many-to-one entity type association.
    &quot;&quot;&quot;

    pass</div>



<div class="viewcode-block" id="ToMany">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToMany">[docs]</a>
class ToMany(
    Generic[OwnerT, AssociateT], ToManyEntityTypeAssociation[OwnerT, AssociateT]
):
    &quot;&quot;&quot;
    A unidirectional to-many entity type association.
    &quot;&quot;&quot;

<div class="viewcode-block" id="ToMany.initialize">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ToMany.initialize">[docs]</a>
    @override
    def initialize(self, owner: OwnerT &amp; Entity) -&gt; None:
        setattr(
            owner,
            self._owner_private_attr_name,
            SingleTypeEntityCollection[AssociateT](self.associate_type),
        )</div>
</div>



<div class="viewcode-block" id="OneToMany">
<a class="viewcode-back" href="../../../betty.model/#betty.model.OneToMany">[docs]</a>
class OneToMany(
    Generic[OwnerT, AssociateT],
    BidirectionalToManyEntityTypeAssociation[OwnerT, AssociateT],
):
    &quot;&quot;&quot;
    A bidirectional one-to-many entity type association.
    &quot;&quot;&quot;

    pass</div>



<div class="viewcode-block" id="ManyToMany">
<a class="viewcode-back" href="../../../betty.model/#betty.model.ManyToMany">[docs]</a>
class ManyToMany(
    Generic[OwnerT, AssociateT],
    BidirectionalToManyEntityTypeAssociation[OwnerT, AssociateT],
):
    &quot;&quot;&quot;
    A bidirectional many-to-many entity type association.
    &quot;&quot;&quot;

    pass</div>



ToAny: TypeAlias = (
    ToOneEntityTypeAssociation[OwnerT, AssociateT]
    | ToManyEntityTypeAssociation[OwnerT, AssociateT]
)


<div class="viewcode-block" id="to_one">
<a class="viewcode-back" href="../../../betty.model/#betty.model.to_one">[docs]</a>
def to_one(
    owner_attr_name: str,
    associate_type_name: str,
) -&gt; Callable[[type[OwnerT]], type[OwnerT]]:
    &quot;&quot;&quot;
    Add a unidirectional to-one association to an entity or entity mixin.
    &quot;&quot;&quot;

    def _decorator(owner_type: type[OwnerT]) -&gt; type[OwnerT]:
        ToOne(
            owner_type,
            owner_attr_name,
            associate_type_name,
        ).register()
        return owner_type

    return _decorator</div>



<div class="viewcode-block" id="one_to_one">
<a class="viewcode-back" href="../../../betty.model/#betty.model.one_to_one">[docs]</a>
def one_to_one(
    owner_attr_name: str,
    associate_type_name: str,
    associate_attr_name: str,
) -&gt; Callable[[type[OwnerT]], type[OwnerT]]:
    &quot;&quot;&quot;
    Add a bidirectional one-to-one association to an entity or entity mixin.
    &quot;&quot;&quot;

    def _decorator(owner_type: type[OwnerT]) -&gt; type[OwnerT]:
        OneToOne(
            owner_type,
            owner_attr_name,
            associate_type_name,
            associate_attr_name,
        ).register()
        return owner_type

    return _decorator</div>



<div class="viewcode-block" id="many_to_one">
<a class="viewcode-back" href="../../../betty.model/#betty.model.many_to_one">[docs]</a>
def many_to_one(
    owner_attr_name: str,
    associate_type_name: str,
    associate_attr_name: str,
) -&gt; Callable[[type[OwnerT]], type[OwnerT]]:
    &quot;&quot;&quot;
    Add a bidirectional many-to-one association to an entity or entity mixin.
    &quot;&quot;&quot;

    def _decorator(owner_type: type[OwnerT]) -&gt; type[OwnerT]:
        ManyToOne(
            owner_type,
            owner_attr_name,
            associate_type_name,
            associate_attr_name,
        ).register()
        return owner_type

    return _decorator</div>



<div class="viewcode-block" id="to_many">
<a class="viewcode-back" href="../../../betty.model/#betty.model.to_many">[docs]</a>
def to_many(
    owner_attr_name: str,
    associate_type_name: str,
) -&gt; Callable[[type[OwnerT]], type[OwnerT]]:
    &quot;&quot;&quot;
    Add a unidirectional to-many association to an entity or entity mixin.
    &quot;&quot;&quot;

    def _decorator(owner_type: type[OwnerT]) -&gt; type[OwnerT]:
        ToMany(
            owner_type,
            owner_attr_name,
            associate_type_name,
        ).register()
        return owner_type

    return _decorator</div>



<div class="viewcode-block" id="one_to_many">
<a class="viewcode-back" href="../../../betty.model/#betty.model.one_to_many">[docs]</a>
def one_to_many(
    owner_attr_name: str,
    associate_type_name: str,
    associate_attr_name: str,
) -&gt; Callable[[type[OwnerT]], type[OwnerT]]:
    &quot;&quot;&quot;
    Add a bidirectional one-to-many association to an entity or entity mixin.
    &quot;&quot;&quot;

    def _decorator(owner_type: type[OwnerT]) -&gt; type[OwnerT]:
        OneToMany(
            owner_type,
            owner_attr_name,
            associate_type_name,
            associate_attr_name,
        ).register()
        return owner_type

    return _decorator</div>



<div class="viewcode-block" id="many_to_many">
<a class="viewcode-back" href="../../../betty.model/#betty.model.many_to_many">[docs]</a>
def many_to_many(
    owner_attr_name: str,
    associate_type_name: str,
    associate_attr_name: str,
) -&gt; Callable[[type[OwnerT]], type[OwnerT]]:
    &quot;&quot;&quot;
    Add a bidirectional many-to-many association to an entity or entity mixin.
    &quot;&quot;&quot;

    def _decorator(owner_type: type[OwnerT]) -&gt; type[OwnerT]:
        ManyToMany(
            owner_type,
            owner_attr_name,
            associate_type_name,
            associate_attr_name,
        ).register()
        return owner_type

    return _decorator</div>



<div class="viewcode-block" id="many_to_one_to_many">
<a class="viewcode-back" href="../../../betty.model/#betty.model.many_to_one_to_many">[docs]</a>
def many_to_one_to_many(
    left_associate_type_name: str,
    left_associate_attr_name: str,
    left_owner_attr_name: str,
    right_owner_attr_name: str,
    right_associate_type_name: str,
    right_associate_attr_name: str,
) -&gt; Callable[[type[OwnerT]], type[OwnerT]]:
    &quot;&quot;&quot;
    Add a bidirectional many-to-one-to-many association to an entity or entity mixin.
    &quot;&quot;&quot;

    def _decorator(owner_type: type[OwnerT]) -&gt; type[OwnerT]:
        ManyToOne(
            owner_type,
            left_owner_attr_name,
            left_associate_type_name,
            left_associate_attr_name,
        ).register()
        ManyToOne(
            owner_type,
            right_owner_attr_name,
            right_associate_type_name,
            right_associate_attr_name,
        ).register()
        return owner_type

    return _decorator</div>



<div class="viewcode-block" id="EntityTypeAssociationRegistry">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityTypeAssociationRegistry">[docs]</a>
class EntityTypeAssociationRegistry:
    &quot;&quot;&quot;
    Inspect any known entity type associations.
    &quot;&quot;&quot;

    _associations = set[ToAny[Any, Any]]()

<div class="viewcode-block" id="EntityTypeAssociationRegistry.get_all_associations">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityTypeAssociationRegistry.get_all_associations">[docs]</a>
    @classmethod
    def get_all_associations(cls, owner: type | object) -&gt; set[ToAny[Any, Any]]:
        &quot;&quot;&quot;
        Get all associations for an owner.
        &quot;&quot;&quot;
        owner_type = owner if isinstance(owner, type) else type(owner)
        return {
            association
            for association in cls._associations
            if association.owner_type in owner_type.__mro__
        }</div>


<div class="viewcode-block" id="EntityTypeAssociationRegistry.get_association">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityTypeAssociationRegistry.get_association">[docs]</a>
    @classmethod
    def get_association(
        cls, owner: type[OwnerT] | OwnerT &amp; Entity, owner_attr_name: str
    ) -&gt; ToAny[OwnerT, Any]:
        &quot;&quot;&quot;
        Get the association for a given owner and attribute name.
        &quot;&quot;&quot;
        for association in cls.get_all_associations(owner):
            if association.owner_attr_name == owner_attr_name:
                return association
        raise ValueError(
            f&quot;No association exists for {fully_qualified_type_name(owner if isinstance(owner, type) else owner.__class__)}.{owner_attr_name}.&quot;
        )</div>


<div class="viewcode-block" id="EntityTypeAssociationRegistry.get_associates">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityTypeAssociationRegistry.get_associates">[docs]</a>
    @classmethod
    def get_associates(
        cls, owner: EntityT, association: ToAny[EntityT, AssociateT]
    ) -&gt; Iterable[AssociateT]:
        &quot;&quot;&quot;
        Get the associates for a given owner and association.
        &quot;&quot;&quot;
        associates: AssociateT | None | Iterable[AssociateT] = getattr(  # type: ignore[assignment]
            owner, f&quot;_{association.owner_attr_name}&quot;
        )
        if isinstance(association, ToOneEntityTypeAssociation):
            if associates is None:
                return
            yield cast(AssociateT, associates)
            return
        yield from cast(Iterable[AssociateT], associates)</div>


    @classmethod
    def _register(cls, association: ToAny[Any, Any]) -&gt; None:
        cls._associations.add(association)

<div class="viewcode-block" id="EntityTypeAssociationRegistry.initialize">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityTypeAssociationRegistry.initialize">[docs]</a>
    @classmethod
    def initialize(cls, *owners: Entity) -&gt; None:
        &quot;&quot;&quot;
        Initialize the given owners&#39; associations.
        &quot;&quot;&quot;
        for owner in owners:
            for association in cls.get_all_associations(owner):
                association.initialize(owner)</div>


<div class="viewcode-block" id="EntityTypeAssociationRegistry.finalize">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityTypeAssociationRegistry.finalize">[docs]</a>
    @classmethod
    def finalize(cls, *owners: Entity) -&gt; None:
        &quot;&quot;&quot;
        Finalize all associations from the given owners.
        &quot;&quot;&quot;
        for owner in owners:
            for association in cls.get_all_associations(owner):
                association.finalize(owner)</div>
</div>



<div class="viewcode-block" id="SingleTypeEntityCollection">
<a class="viewcode-back" href="../../../betty.model/#betty.model.SingleTypeEntityCollection">[docs]</a>
class SingleTypeEntityCollection(Generic[TargetT], EntityCollection[TargetT]):
    &quot;&quot;&quot;
    Collect entities of a single type.
    &quot;&quot;&quot;

    __slots__ = &quot;_entities&quot;, &quot;_target_type&quot;

<div class="viewcode-block" id="SingleTypeEntityCollection.__init__">
<a class="viewcode-back" href="../../../betty.model/#betty.model.SingleTypeEntityCollection.__init__">[docs]</a>
    def __init__(
        self,
        target_type: type[TargetT],
    ):
        super().__init__()
        self._entities: list[TargetT &amp; Entity] = []
        self._target_type = target_type</div>


    @override  # type: ignore[callable-functiontype]
    @recursive_repr()
    def __repr__(self) -&gt; str:
        return repr_instance(self, target_type=self._target_type, length=len(self))

<div class="viewcode-block" id="SingleTypeEntityCollection.add">
<a class="viewcode-back" href="../../../betty.model/#betty.model.SingleTypeEntityCollection.add">[docs]</a>
    @override
    def add(self, *entities: TargetT &amp; Entity) -&gt; None:
        added_entities = [*self._unknown(*entities)]
        for entity in added_entities:
            self._entities.append(entity)
        if added_entities:
            self._on_add(*added_entities)</div>


<div class="viewcode-block" id="SingleTypeEntityCollection.remove">
<a class="viewcode-back" href="../../../betty.model/#betty.model.SingleTypeEntityCollection.remove">[docs]</a>
    @override
    def remove(self, *entities: TargetT &amp; Entity) -&gt; None:
        removed_entities = [*self._known(*entities)]
        for entity in removed_entities:
            self._entities.remove(entity)
        if removed_entities:
            self._on_remove(*removed_entities)</div>


<div class="viewcode-block" id="SingleTypeEntityCollection.clear">
<a class="viewcode-back" href="../../../betty.model/#betty.model.SingleTypeEntityCollection.clear">[docs]</a>
    @override
    def clear(self) -&gt; None:
        self.remove(*self)</div>


    @override
    def __iter__(self) -&gt; Iterator[TargetT &amp; Entity]:
        return self._entities.__iter__()

    @override
    def __len__(self) -&gt; int:
        return len(self._entities)

    @overload
    def __getitem__(self, index: int) -&gt; TargetT &amp; Entity:
        pass

    @overload
    def __getitem__(self, indices: slice) -&gt; list[TargetT &amp; Entity]:
        pass

    @overload
    def __getitem__(self, entity_id: str) -&gt; TargetT &amp; Entity:
        pass

    @override
    def __getitem__(
        self, key: int | slice | str
    ) -&gt; TargetT &amp; Entity | list[TargetT &amp; Entity]:
        if isinstance(key, int):
            return self._getitem_by_index(key)
        if isinstance(key, slice):
            return self._getitem_by_indices(key)
        return self._getitem_by_entity_id(key)

    def _getitem_by_index(self, index: int) -&gt; TargetT &amp; Entity:
        return self._entities[index]

    def _getitem_by_indices(self, indices: slice) -&gt; list[TargetT &amp; Entity]:
        return self.view[indices]

    def _getitem_by_entity_id(self, entity_id: str) -&gt; TargetT &amp; Entity:
        for entity in self._entities:
            if entity_id == entity.id:
                return entity
        raise KeyError(
            f&#39;Cannot find a {self._target_type} entity with ID &quot;{entity_id}&quot;.&#39;
        )

    @override
    def __delitem__(self, key: str | TargetT &amp; Entity) -&gt; None:
        if isinstance(key, self._target_type):
            return self._delitem_by_entity(cast(&quot;TargetT &amp; Entity&quot;, key))
        if isinstance(key, str):
            return self._delitem_by_entity_id(key)
        raise TypeError(f&quot;Cannot find entities by {repr(key)}.&quot;)

    def _delitem_by_entity(self, entity: TargetT &amp; Entity) -&gt; None:
        self.remove(entity)

    def _delitem_by_entity_id(self, entity_id: str) -&gt; None:
        for entity in self._entities:
            if entity_id == entity.id:
                self.remove(entity)
                return

    @override
    def __contains__(self, value: Any) -&gt; bool:
        if isinstance(value, self._target_type):
            return self._contains_by_entity(cast(&quot;TargetT &amp; Entity&quot;, value))
        if isinstance(value, str):
            return self._contains_by_entity_id(value)
        return False

    def _contains_by_entity(self, other_entity: TargetT &amp; Entity) -&gt; bool:
        return any(other_entity is entity for entity in self._entities)

    def _contains_by_entity_id(self, entity_id: str) -&gt; bool:
        return any(entity.id == entity_id for entity in self._entities)</div>



SingleTypeEntityCollectionT = TypeVar(
    &quot;SingleTypeEntityCollectionT&quot;, bound=SingleTypeEntityCollection[AssociateT]
)


<div class="viewcode-block" id="MultipleTypesEntityCollection">
<a class="viewcode-back" href="../../../betty.model/#betty.model.MultipleTypesEntityCollection">[docs]</a>
class MultipleTypesEntityCollection(Generic[TargetT], EntityCollection[TargetT]):
    &quot;&quot;&quot;
    Collect entities of multiple types.
    &quot;&quot;&quot;

    __slots__ = &quot;_collections&quot;

<div class="viewcode-block" id="MultipleTypesEntityCollection.__init__">
<a class="viewcode-back" href="../../../betty.model/#betty.model.MultipleTypesEntityCollection.__init__">[docs]</a>
    def __init__(self):
        super().__init__()
        self._collections: dict[type[Entity], SingleTypeEntityCollection[Entity]] = {}</div>


    @override  # type: ignore[callable-functiontype]
    @recursive_repr()
    def __repr__(self) -&gt; str:
        return repr_instance(
            self,
            entity_types=&quot;, &quot;.join(map(get_entity_type_name, self._collections.keys())),
            length=len(self),
        )

    def _get_collection(
        self, entity_type: type[EntityT]
    ) -&gt; SingleTypeEntityCollection[EntityT]:
        assert issubclass(entity_type, Entity), f&quot;{entity_type} is not an entity type.&quot;
        try:
            return cast(
                SingleTypeEntityCollection[EntityT], self._collections[entity_type]
            )
        except KeyError:
            self._collections[entity_type] = SingleTypeEntityCollection(entity_type)
            return cast(
                SingleTypeEntityCollection[EntityT], self._collections[entity_type]
            )

    @overload
    def __getitem__(self, index: int) -&gt; TargetT &amp; Entity:
        pass

    @overload
    def __getitem__(self, indices: slice) -&gt; list[TargetT &amp; Entity]:
        pass

    @overload
    def __getitem__(self, entity_type_name: str) -&gt; SingleTypeEntityCollection[Entity]:
        pass

    @overload
    def __getitem__(
        self, entity_type: type[EntityT]
    ) -&gt; SingleTypeEntityCollection[EntityT]:
        pass

    @override
    def __getitem__(
        self,
        key: int | slice | str | type[EntityT],
    ) -&gt; (
        TargetT &amp; Entity
        | SingleTypeEntityCollection[Entity]
        | SingleTypeEntityCollection[EntityT]
        | list[TargetT &amp; Entity]
    ):
        if isinstance(key, int):
            return self._getitem_by_index(key)
        if isinstance(key, slice):
            return self._getitem_by_indices(key)
        if isinstance(key, str):
            return self._getitem_by_entity_type_name(key)
        return self._getitem_by_entity_type(key)

    def _getitem_by_entity_type(
        self, entity_type: type[EntityT]
    ) -&gt; SingleTypeEntityCollection[EntityT]:
        return self._get_collection(entity_type)

    def _getitem_by_entity_type_name(
        self, entity_type_name: str
    ) -&gt; SingleTypeEntityCollection[Entity]:
        return self._get_collection(
            get_entity_type(entity_type_name),
        )

    def _getitem_by_index(self, index: int) -&gt; TargetT &amp; Entity:
        return self.view[index]

    def _getitem_by_indices(self, indices: slice) -&gt; list[TargetT &amp; Entity]:
        return self.view[indices]

    @override
    def __delitem__(self, key: str | type[TargetT &amp; Entity] | TargetT &amp; Entity) -&gt; None:
        if isinstance(key, type):
            return self._delitem_by_type(
                key,
            )
        if isinstance(key, Entity):
            return self._delitem_by_entity(
                key,  # type: ignore[arg-type]
            )
        return self._delitem_by_entity_type_name(key)

    def _delitem_by_type(self, entity_type: type[TargetT &amp; Entity]) -&gt; None:
        removed_entities = [*self._get_collection(entity_type)]
        self._get_collection(entity_type).clear()
        if removed_entities:
            self._on_remove(*removed_entities)

    def _delitem_by_entity(self, entity: TargetT &amp; Entity) -&gt; None:
        self.remove(entity)

    def _delitem_by_entity_type_name(self, entity_type_name: str) -&gt; None:
        self._delitem_by_type(
            get_entity_type(entity_type_name),  # type: ignore[arg-type]
        )

    @override
    def __iter__(self) -&gt; Iterator[TargetT &amp; Entity]:
        for collection in self._collections.values():
            for entity in collection:
                yield cast(&quot;TargetT &amp; Entity&quot;, entity)

    @override
    def __len__(self) -&gt; int:
        return sum(map(len, self._collections.values()))

    @override
    def __contains__(self, value: Any) -&gt; bool:
        if isinstance(value, Entity):
            return self._contains_by_entity(value)
        return False

    def _contains_by_entity(self, other_entity: Any) -&gt; bool:
        return any(other_entity is entity for entity in self)

<div class="viewcode-block" id="MultipleTypesEntityCollection.add">
<a class="viewcode-back" href="../../../betty.model/#betty.model.MultipleTypesEntityCollection.add">[docs]</a>
    @override
    def add(self, *entities: TargetT &amp; Entity) -&gt; None:
        added_entities = [*self._unknown(*entities)]
        for entity in added_entities:
            self[entity.type].add(entity)
        if added_entities:
            self._on_add(*added_entities)</div>


<div class="viewcode-block" id="MultipleTypesEntityCollection.remove">
<a class="viewcode-back" href="../../../betty.model/#betty.model.MultipleTypesEntityCollection.remove">[docs]</a>
    @override
    def remove(self, *entities: TargetT &amp; Entity) -&gt; None:
        removed_entities = [*self._known(*entities)]
        for entity in removed_entities:
            self[entity.type].remove(entity)
        if removed_entities:
            self._on_remove(*removed_entities)</div>


<div class="viewcode-block" id="MultipleTypesEntityCollection.clear">
<a class="viewcode-back" href="../../../betty.model/#betty.model.MultipleTypesEntityCollection.clear">[docs]</a>
    @override
    def clear(self) -&gt; None:
        removed_entities = (*self,)
        for collection in self._collections.values():
            collection.clear()
        if removed_entities:
            self._on_remove(*removed_entities)</div>
</div>



class _BidirectionalAssociateCollection(
    Generic[AssociateT, OwnerT], SingleTypeEntityCollection[AssociateT]
):
    __slots__ = &quot;__owner&quot;, &quot;_association&quot;

    def __init__(
        self,
        owner: OwnerT &amp; Entity,
        association: BidirectionalEntityTypeAssociation[OwnerT, AssociateT],
    ):
        super().__init__(association.associate_type)
        self._association = association
        self.__owner = weakref.ref(owner)

    @property
    def _owner(self) -&gt; OwnerT &amp; Entity:
        owner = self.__owner()
        if owner is None:
            raise RuntimeError(
                &quot;This associate collection&#39;s owner no longer exists in memory.&quot;
            )
        return owner

    @override
    def _on_add(self, *entities: AssociateT &amp; Entity) -&gt; None:
        super()._on_add(*entities)
        for associate in entities:
            self._association.inverse().associate(associate, self._owner)

    @override
    def _on_remove(self, *entities: AssociateT &amp; Entity) -&gt; None:
        super()._on_remove(*entities)
        for associate in entities:
            self._association.inverse().disassociate(associate, self._owner)


<div class="viewcode-block" id="AliasedEntity">
<a class="viewcode-back" href="../../../betty.model/#betty.model.AliasedEntity">[docs]</a>
class AliasedEntity(Generic[EntityT]):
    &quot;&quot;&quot;
    An aliased entity wraps an entity and gives aliases its ID.

    Aliases are used when deserializing ancestries from sources where intermediate IDs
    are used to declare associations between entities. By wrapping an entity in an alias,
    the alias can use the intermediate ID, allowing it to be inserted into APIs such as
    :py:class:`betty.model.EntityGraphBuilder` who will use the alias ID to finalize
    associations before the original entities are returned.
    &quot;&quot;&quot;

<div class="viewcode-block" id="AliasedEntity.__init__">
<a class="viewcode-back" href="../../../betty.model/#betty.model.AliasedEntity.__init__">[docs]</a>
    def __init__(self, original_entity: EntityT, aliased_entity_id: str | None = None):
        self._entity = original_entity
        self._id = (
            GeneratedEntityId() if aliased_entity_id is None else aliased_entity_id
        )</div>


    @override
    def __repr__(self) -&gt; str:
        return repr_instance(self, id=self.id)

    @property
    def type(self) -&gt; builtins.type[Entity]:
        &quot;&quot;&quot;
        The type of the aliased entity.
        &quot;&quot;&quot;
        return self._entity.type

    @property
    def id(self) -&gt; str:
        &quot;&quot;&quot;
        The alias entity ID.
        &quot;&quot;&quot;
        return self._id

<div class="viewcode-block" id="AliasedEntity.unalias">
<a class="viewcode-back" href="../../../betty.model/#betty.model.AliasedEntity.unalias">[docs]</a>
    def unalias(self) -&gt; EntityT:
        &quot;&quot;&quot;
        Get the original entity.
        &quot;&quot;&quot;
        return self._entity</div>
</div>



AliasableEntity: TypeAlias = EntityT | AliasedEntity[EntityT]


<div class="viewcode-block" id="unalias">
<a class="viewcode-back" href="../../../betty.model/#betty.model.unalias">[docs]</a>
def unalias(entity: AliasableEntity[EntityT]) -&gt; EntityT:
    &quot;&quot;&quot;
    Unalias a potentially aliased entity.
    &quot;&quot;&quot;
    if isinstance(entity, AliasedEntity):
        return entity.unalias()
    return entity</div>



_EntityGraphBuilderEntities: TypeAlias = dict[
    type[Entity], dict[str, AliasableEntity[Entity]]
]


_EntityGraphBuilderAssociations: TypeAlias = dict[
    type[Entity],  # The owner entity type.
    dict[
        str,  # The owner attribute name.
        dict[str, list[AncestryEntityId]],  # The owner ID.  # The associate IDs.
    ],
]


class _EntityGraphBuilder:
    def __init__(self):
        self._entities: _EntityGraphBuilderEntities = defaultdict(dict)
        self._associations: _EntityGraphBuilderAssociations = defaultdict(
            lambda: defaultdict(lambda: defaultdict(list))
        )
        self._built = False

    def _assert_unbuilt(self) -&gt; None:
        if self._built:
            raise RuntimeError(&quot;This entity graph has been built already.&quot;)

    def _iter(self) -&gt; Iterator[AliasableEntity[Entity]]:
        for entity_type in self._entities:
            yield from self._entities[entity_type].values()

    def _build_associations(self) -&gt; None:
        for owner_type, owner_attrs in self._associations.items():
            for owner_attr_name, owner_associations in owner_attrs.items():
                association = EntityTypeAssociationRegistry.get_association(
                    owner_type, owner_attr_name
                )
                for owner_id, associate_ancestry_ids in owner_associations.items():
                    associates = [
                        unalias(self._entities[associate_type][associate_id])
                        for associate_type, associate_id in associate_ancestry_ids
                    ]
                    owner = unalias(self._entities[owner_type][owner_id])
                    if isinstance(association, ToOneEntityTypeAssociation):
                        association.set(owner, associates[0])
                    else:
                        association.set(owner, associates)

    def build(self) -&gt; Iterator[Entity]:
        self._assert_unbuilt()
        self._built = True

        unaliased_entities = list(
            map(
                unalias,
                self._iter(),
            )
        )

        EntityTypeAssociationRegistry.initialize(*unaliased_entities)
        self._build_associations()

        yield from unaliased_entities


<div class="viewcode-block" id="EntityGraphBuilder">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityGraphBuilder">[docs]</a>
class EntityGraphBuilder(_EntityGraphBuilder):
    &quot;&quot;&quot;
    Assemble entities and their associations.

    (De)serializing data often means that special care must be taken with the associations,
    relationships, or links between data points, as those form a graph, a network, a tangled
    web of data. When deserializing entity A with an association to entity B, that association
    cannot be finalized until entity B is parsed as well. But, if entity B subsequently has
    an association with entity A (the association is bidirectional), this results in an endless
    cycle.

    This class prevents the problem by letting you add entities and associations separately.
    Associations are finalized when you are done adding, avoiding cycle errors.
    &quot;&quot;&quot;

<div class="viewcode-block" id="EntityGraphBuilder.add_entity">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityGraphBuilder.add_entity">[docs]</a>
    def add_entity(self, *entities: AliasableEntity[Entity]) -&gt; None:
        &quot;&quot;&quot;
        Add entities to the graph.
        &quot;&quot;&quot;
        self._assert_unbuilt()

        for entity in entities:
            self._entities[entity.type][entity.id] = entity</div>


<div class="viewcode-block" id="EntityGraphBuilder.add_association">
<a class="viewcode-back" href="../../../betty.model/#betty.model.EntityGraphBuilder.add_association">[docs]</a>
    def add_association(
        self,
        owner_type: type[Entity],
        owner_id: str,
        owner_attr_name: str,
        associate_type: type[Entity],
        associate_id: str,
    ) -&gt; None:
        &quot;&quot;&quot;
        Add an association between two entities to the graph.
        &quot;&quot;&quot;
        self._assert_unbuilt()

        self._associations[owner_type][owner_attr_name][owner_id].append(
            (associate_type, associate_id)
        )</div>
</div>



<div class="viewcode-block" id="record_added">
<a class="viewcode-back" href="../../../betty.model/#betty.model.record_added">[docs]</a>
@contextmanager
def record_added(
    entities: EntityCollection[EntityT],
) -&gt; Iterator[MultipleTypesEntityCollection[EntityT]]:
    &quot;&quot;&quot;
    Record all entities that are added to a collection.
    &quot;&quot;&quot;
    original = [*entities]
    added = MultipleTypesEntityCollection[EntityT]()
    yield added
    added.add(*[entity for entity in entities if entity not in original])</div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; Bart Feenstra and contributors
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=187304be"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=4e2eecee"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    </body>
</html>