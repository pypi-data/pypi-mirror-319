import{v as N,N as z,ak as D,u as R,bZ as H,bD as F,b_ as E,c as Q,G as J}from"./index-Bm2SqMk3.js";import{f as A}from"./color-C8H6Smlh.js";import{g as Z}from"./getMaximumModificationAtEachPosition-CxK0lV1P.js";function K(t){return t.get("is_paired")&&t.get("refName")!==t.get("next_ref")?"#555":`hsl(${Math.abs(t.get("template_length"))/10},50%,50%)`}function U(t){return`hsl(${t.get("score")},50%,50%)`}function V(t,r){const i=N.readConfObject(r,"orientationType"),b=z[i][t.get("pair_orientation")];return{LR:"color_pair_lr",RR:"color_pair_rr",RL:"color_pair_rl",LL:"color_pair_ll"}[b]}function Y(t){return t.get("strand")===-1?"#8F8FD8":"#EC8B8B"}function W(t,r){return A[V(t,r)||"color_nostrand"]}function tt(t){const r=t.get("flags"),i=t.get("strand");if(r&1){const u=r&64?-1:1;return r&2?i*u===1?"color_rev_strand":"color_fwd_strand":r&8?i*u===1?"color_rev_missing_mate":"color_fwd_missing_mate":t.get("refName")===t.get("next_ref")?i*u===1?"color_rev_strand_not_proper":"color_fwd_strand_not_proper":i===1?"color_fwd_diff_chr":"color_rev_diff_chr"}return"color_unknown"}function et(t){return A[tt(t)]}function ot({colorType:t,tag:r,feature:i,config:u,defaultColor:b,colorTagMap:l}){switch(t){case"insertSize":return K(i);case"strand":return Y(i);case"mappingQuality":return U(i);case"pairOrientation":return W(i,u);case"stranded":return et(i);case"xs":case"tag":{const n=i.get("tags"),m=n?n[r]:i.get(r);return r==="XS"||r==="TS"?m==="-"?A.color_rev_strand:m==="+"?A.color_fwd_strand:A.color_nostrand:r==="ts"?m==="-"?i.get("strand")===-1?A.color_fwd_strand:A.color_rev_strand:m==="+"?i.get("strand")===-1?A.color_rev_strand:A.color_fwd_strand:A.color_nostrand:l[m]||A.color_nostrand}case"insertSizeAndPairOrientation":break;case"modifications":case"methylation":return i.get("flags")&16?"#c8dcc8":"#c8c8c8";default:return b?"lightgrey":N.readConfObject(u,"color",{feature:i})}}function nt({ctx:t,feat:r,renderArgs:i}){const{regions:u,bpPerPx:b}=i,{heightPx:l,topPx:n,feature:m}=r,P=u[0],S=m.get("start"),h=m.get("end"),M=m.get("CIGAR"),q=P.reversed?-1:1,g=m.get("strand")*q,w=b<10&&l>5;if(M!=null&&M.includes("N")){const o=D(M);if(g===1){let e=0,p=S;for(let s=0;s<o.length;s+=2){const d=+o[s],c=o[s+1];if(c==="M"||c==="X"||c==="="||c==="D")e+=d;else if(c==="N"){if(p!==e){const[f,C]=R.bpSpanPx(p,p+e,P,b),x=C-f;t.fillRect(f,n,x,l)}p+=e+d,e=0}}if(p!==e){const[s,d]=R.bpSpanPx(p,p+e,P,b),c=d-s;w?(t.beginPath(),t.moveTo(s,n),t.lineTo(s,n+l),t.lineTo(d,n+l),t.lineTo(d+5,n+l/2),t.lineTo(d,n),t.closePath(),t.fill()):t.fillRect(s,n,c,l)}}else if(g===-1){let e=0,p=h;for(let s=o.length-2;s>=0;s-=2){const d=+o[s],c=o[s+1];if(c==="M"||c==="X"||c==="="||c==="D")e+=d;else if(c==="N"){if(e!==0){const[f,C]=R.bpSpanPx(p-e,p,P,b);t.fillRect(f,n,C-f,l)}p-=e+d,e=0}}if(e!==0){const[s,d]=R.bpSpanPx(p-e,p,P,b),c=d-s;w?(t.beginPath(),t.moveTo(s-5,n+l/2),t.lineTo(s,n+l),t.lineTo(d,n+l),t.lineTo(d,n),t.lineTo(s,n),t.closePath(),t.fill()):t.fillRect(s,n,c,l)}}}else{const[o,e]=R.bpSpanPx(S,h,P,b);b<10&&l>5?g===-1?(t.beginPath(),t.moveTo(o-5,n+l/2),t.lineTo(o,n+l),t.lineTo(e,n+l),t.lineTo(e,n),t.lineTo(o,n),t.closePath(),t.fill()):(t.beginPath(),t.moveTo(o,n),t.lineTo(o,n+l),t.lineTo(e,n+l),t.lineTo(e+5,n+l/2),t.lineTo(e,n),t.closePath(),t.fill()):t.fillRect(o,n,e-o,l)}}function B(t,r,i,u,b,l,n){r+u<0||r>l||(n&&(t.fillStyle=n),t.fillRect(r,i,u,b))}function $(t){const{bases:r}=t.palette;return{A:r.A.main,C:r.C.main,G:r.G.main,T:r.T.main,deletion:"#808080"}}function st(t){return Object.fromEntries(Object.entries($(t)).map(([r,i])=>[r,t.palette.getContrastText(i)]))}function rt(t){return["methylation","modifications"].includes(t||"")}function it(){return!0}function X(){const t=R.measureText("A"),r=R.measureText("M")-2;return{charWidth:t,charHeight:r}}function lt({ctx:t,feat:r,region:i,bpPerPx:u,renderArgs:b,canvasWidth:l,cigarOps:n}){var m,P,S;const{feature:h,topPx:M,heightPx:q}=r,{colorBy:g,visibleModifications:w={}}=b;if(!h.get("seq"))return;const e=h.get("start"),p=(m=g==null?void 0:g.modifications)===null||m===void 0?void 0:m.isolatedModification,s=(P=g==null?void 0:g.modifications)===null||P===void 0?void 0:P.twoColor;(S=Z(h,n))===null||S===void 0||S.forEach(({allProbs:d,prob:c,type:f},C)=>{const x=e+C,[a,T]=R.bpSpanPx(x,x+1,i,u),I=w[f];if(!I){console.warn(`${f} not known yet`);return}if(p&&I.type!==p)return;const L=I.color||"black",y=1-R.sum(d);if(s&&y>R.max(d)){const k=H("blue",y),O=T-a+.5;B(t,a,M,O,q,l,k)}else{const k=H(L,c),O=T-a+.5;B(t,a,M,O,q,l,k)}})}function ct({ctx:t,feat:r,region:i,bpPerPx:u,colorForBase:b,contrastForBase:l,charWidth:n,charHeight:m,canvasWidth:P,cigarOps:S}){const h=m-2,{feature:M,topPx:q,heightPx:g}=r,w=M.get("seq"),o=1/u,e=M.get("start");let p=0,s=0;if(w)for(let d=0;d<S.length;d+=2){const c=+S[d],f=S[d+1];if(f==="S"||f==="I")p+=c;else if(f==="D"||f==="N")s+=c;else if(f==="M"||f==="X"||f==="="){for(let C=0;C<c;C++){const x=w[p+C],a=e+s+C,[T]=R.bpSpanPx(a,a+1,i,u),I=b[x];B(t,T,q,o+.5,g,P,I),o>=n&&g>=h&&(t.fillStyle=l[x],t.fillText(x,T+(o-n)/2+1,q+g))}p+=c,s+=c}}}function at({ctx:t,feat:r,region:i,bpPerPx:u,canvasWidth:b,cigarOps:l}){const{feature:n,topPx:m,heightPx:P}=r,h=(n.get("qual")||"").split(" ").map(o=>+o),M=1/u,q=n.get("start");let g=0,w=0;for(let o=0;o<l.length;o+=2){const e=+l[o],p=l[o+1];if(p==="S"||p==="I")g+=e;else if(p==="D"||p==="N")w+=e;else if(p==="M"||p==="X"||p==="="){for(let s=0;s<e;s++){const d=h[g+s],c=q+w+s,f=R.bpSpanPx(c,c+1,i,u)[0],C=`hsl(${d===255?150:d*1.5},55%,50%)`;B(t,f,m,M+.5,P,b,C)}g+=e,w+=e}}}function ft({ctx:t,feat:r,region:i,bpPerPx:u,renderArgs:b,canvasWidth:l,cigarOps:n}){const{regionSequence:m}=b,{feature:P,topPx:S,heightPx:h}=r;if(!m)throw new Error("region sequence required for methylation");if(!P.get("seq"))return;const q=P.get("start"),g=P.get("end"),{methBins:w,methProbs:o,hydroxyMethBins:e,hydroxyMethProbs:p}=F(P,n);function s(c){if(w[c]){const f=o[c]||0;return(f>.5?E.colord("red").alpha((f-.5)*2):E.colord("blue").alpha(1-f*2)).toHslString()}if(e[c]){const f=p[c]||0;return(f>.5?E.colord("pink").alpha((f-.5)*2):E.colord("purple").alpha(1-f*2)).toHslString()}}const d=m.toLowerCase();for(let c=0;c<g-q;c++){const f=c+q,C=d[f-i.start+1],x=d[f-i.start+2];if(C==="c"&&x==="g")if(u>2){const[a,T]=R.bpSpanPx(f,f+2,i,u),I=T-a+.5,L=s(c)||s(c+1)||"blue";B(t,a,S,I,h,l,L)}else{const[a,T]=R.bpSpanPx(f,f+1,i,u),I=T-a+.5,L=s(c)||"blue";B(t,a,S,I,h,l,L);const[y,k]=R.bpSpanPx(f+1,f+2,i,u),O=k-y+.5,_=s(c+1)||"blue";B(t,y,S,O,h,l,_)}}}function pt({ctx:t,feat:r,renderArgs:i,colorForBase:u,contrastForBase:b,charWidth:l,charHeight:n,defaultColor:m,canvasWidth:P}){const{config:S,bpPerPx:h,regions:M,colorBy:q,colorTagMap:g={}}=i,{tag:w="",type:o=""}=q||{},{feature:e}=r,p=M[0];switch(t.fillStyle=ot({feature:e,config:S,tag:w,defaultColor:m,colorType:o,colorTagMap:g}),nt({ctx:t,feat:r,renderArgs:i}),o){case"perBaseQuality":{const s=D(e.get("CIGAR"));at({ctx:t,feat:r,region:p,bpPerPx:h,canvasWidth:P,cigarOps:s});break}case"perBaseLettering":{const s=D(e.get("CIGAR"));ct({ctx:t,feat:r,region:p,bpPerPx:h,colorForBase:u,contrastForBase:b,charWidth:l,charHeight:n,canvasWidth:P,cigarOps:s});break}case"modifications":{const s=D(e.get("CIGAR"));lt({ctx:t,feat:r,region:p,bpPerPx:h,renderArgs:i,canvasWidth:P,cigarOps:s});break}case"methylation":{const s=D(e.get("CIGAR"));ft({ctx:t,feat:r,region:p,bpPerPx:h,renderArgs:i,canvasWidth:P,cigarOps:s});break}}}function gt({ctx:t,feat:r,renderArgs:i,minSubfeatureWidth:u,largeInsertionIndicatorScale:b,mismatchAlpha:l,charWidth:n,charHeight:m,colorForBase:P,contrastForBase:S,canvasWidth:h,drawSNPsMuted:M,drawIndels:q=!0}){const{bpPerPx:g,regions:w}=i,{heightPx:o,topPx:e,feature:p}=r,s=w[0],d=p.get("start"),c=Math.min(1/g,2),f=p.get("mismatches"),C=m-2,x=s.reversed?1/g+1:-1;if(f){for(const a of f){const T=d+a.start,I=a.length,L=a.base,[y,k]=R.bpSpanPx(T,T+I,s,g),O=Math.max(u,k-y);if(a.type==="mismatch"){if(!M){const _=P[a.base]||"#888",v=l&&a.qual!==void 0?E.colord(_).alpha(Math.min(1,a.qual/50)).toHslString():_;B(t,Math.round(y),e,O,o,h,v)}if(O>=n&&o>=C){const _=M?"black":S[a.base]||"black";t.fillStyle=l&&a.qual!==void 0?E.colord(_).alpha(Math.min(1,a.qual/50)).toHslString():_,t.fillText(L,y+(O-n)/2+1,e+o)}}else if(a.type==="deletion"&&q){B(t,y,e,Math.abs(y-k),o,h,P.deletion);const _=`${a.length}`,v=R.measureText(_,10);O>=v&&o>=C&&(t.fillStyle=S.deletion,t.fillText(_,(y+k)/2-v/2,e+o))}else if(a.type==="insertion"&&q){const _=y+x,v=+a.base||a.length,j=Math.max(0,Math.min(1.2,1/g));if(v<10&&(B(t,_,e,j,o,h,"purple"),1/g>=n&&o>=C)){const G=_-j;B(t,G,e,j*3,1,h),B(t,G,e+o-1,j*3,1,h),t.fillText(`(${a.base})`,_+3,e+o)}}else if(a.type==="hardclip"||a.type==="softclip"){const _=y+x,v=a.type==="hardclip"?"red":"blue",j=Math.max(u,c);if(B(t,_,e,j,o,h,v),1/g>=n&&o>=C){const G=_-j;B(t,G,e,j*3,1,h),B(t,G,e+o-1,j*3,1,h),t.fillText(`(${a.base})`,_+3,e+o)}}else if(a.type==="skip"&&y+O>0){const _=O-(g>10?1.5:0),v=Math.max(0,y),j=e+o/2-1,G=_+Math.min(y,0);B(t,v,j,G,1,h,"rgb(151,184,201)")}}if(q)for(const a of f){const T=d+a.start,I=a.length,L=+a.base||a.length;if(a.type==="insertion"&&L>=10){const[y]=R.bpSpanPx(T,T+I,s,g),k=`${L}`;if(g>b)B(t,y-1,e,2,o,h,"purple");else if(o>m){const O=R.measureText(k),_=5;B(t,y-O/2-_,e,O+2*_,o,h,"purple"),t.fillStyle="white",t.fillText(k,y-O/2,e+o)}else B(t,y-2,e,2*2,o,h,"purple")}}}}function dt({ctx:t,feat:r,renderArgs:i,config:u,theme:b,colorForBase:l,canvasWidth:n}){const{feature:m,topPx:P,heightPx:S}=r,{regions:h,bpPerPx:M}=i,q=h[0],g=N.readConfObject(u,"minSubfeatureWidth"),w=m.get("mismatches"),o=m.get("seq"),{charWidth:e,charHeight:p}=X();if(!(o&&w))return;const s=p-2;let d=0,c=0;const f=m.get("CIGAR"),C=D(f);for(let x=0;x<C.length;x+=2){const a=C[x+1],T=+C[x];if(a==="S"){for(let I=0;I<T;I++){const L=o[d+I],y=m.get("start")-(x===0?T:0)+c+I,[k,O]=R.bpSpanPx(y,y+1,q,M),_=Math.max(g,O-k),v=l[L]||"#000000";t.fillStyle=v,B(t,k,P,_,S,n),_>=e&&S>=s&&(t.fillStyle=b.palette.getContrastText(v),t.fillText(L,k+(_-e)/2+1,P+S))}d+=T}a==="N"&&(c+=T),(a==="M"||a==="="||a==="X")&&(c+=T,d+=T),a==="D"&&(c+=T),a==="I"&&(d+=T)}}function bt({ctx:t,layoutRecords:r,canvasWidth:i,renderArgs:u}){const{stopToken:b,config:l,showSoftClip:n,colorBy:m,theme:P}=u,S=N.readConfObject(l,"mismatchAlpha"),h=N.readConfObject(l,"minSubfeatureWidth"),M=N.readConfObject(l,"largeInsertionIndicatorScale"),q=N.readConfObject(l,"color")==="#f0f",g=Q.createJBrowseTheme(P),w=$(g),o=st(g);t.font="bold 10px Courier New,monospace";const{charWidth:e,charHeight:p}=X(),s=rt(m==null?void 0:m.type),d=it();let c=performance.now();for(const f of r)performance.now()-c>400&&(J.checkStopToken(b),c=performance.now()),pt({ctx:t,feat:f,renderArgs:u,defaultColor:q,colorForBase:w,contrastForBase:o,charWidth:e,charHeight:p,canvasWidth:i}),gt({ctx:t,feat:f,renderArgs:u,mismatchAlpha:S,drawSNPsMuted:s,drawIndels:d,largeInsertionIndicatorScale:M,minSubfeatureWidth:h,charWidth:e,charHeight:p,colorForBase:w,contrastForBase:o,canvasWidth:i}),n&&dt({ctx:t,feat:f,renderArgs:u,colorForBase:w,config:l,theme:g,canvasWidth:i})}export{bt as makeImageData};
