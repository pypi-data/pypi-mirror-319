import{bF as Q,aP as q,aR as Y,aS as W,aW as C,bG as S,aN as F,bH as J,bV as z,bW as X,a9 as M,u as R,a7 as K,a8 as Z,G as D,bX as ee,bY as te}from"./index-Bm2SqMk3.js";import{c as ne}from"./crc32-BMWsGF9h.js";import{B as se}from"./index-6rN3ss-L.js";import{Q as ie}from"./QuickLRU-BERSBA88.js";import{r as re}from"./rxjs-DT7GVwt0.js";class G{constructor(e,t){this.blockPosition=e,this.dataPosition=t}toString(){return`${this.blockPosition}:${this.dataPosition}`}compareTo(e){return this.blockPosition-e.blockPosition||this.dataPosition-e.dataPosition}static min(...e){let t,n=0;for(;!t;n+=1)t=e[n];for(;n<e.length;n+=1)t.compareTo(e[n])>0&&(t=e[n]);return t}}function E(d,e=0,t=!1){if(t)throw new Error("big-endian virtual file offsets not implemented");return new G(d[e+7]*1099511627776+d[e+6]*4294967296+d[e+5]*16777216+d[e+4]*65536+d[e+3]*256+d[e+2],d[e+1]<<8|d[e])}class B{constructor(e,t,n,s){this.minv=e,this.maxv=t,this.bin=n,this._fetchedSize=s}toUniqueString(){return`${this.minv.toString()}..${this.maxv.toString()} (bin ${this.bin}, fetchedSize ${this.fetchedSize()})`}toString(){return this.toUniqueString()}compareTo(e){return this.minv.compareTo(e.minv)||this.maxv.compareTo(e.maxv)||this.bin-e.bin}fetchedSize(){return this._fetchedSize!==void 0?this._fetchedSize:this.maxv.blockPosition+65536-this.minv.blockPosition}}function ae(d){return new Promise(e=>setTimeout(e,d))}function oe(d){if(d&&d.aborted)if(typeof DOMException>"u"){const e=new Error("aborted");throw e.code="ERR_ABORTED",e}else throw new DOMException("aborted","AbortError")}function ce(d,e){return e.minv.blockPosition-d.maxv.blockPosition<65e3&&e.maxv.blockPosition-d.minv.blockPosition<5e6}function he(d={}){return"aborted"in d?{signal:d}:d}function H(d,e){const t=[];let n;if(d.length===0)return d;d.sort((s,i)=>{const r=s.minv.blockPosition-i.minv.blockPosition;return r===0?s.minv.dataPosition-i.minv.dataPosition:r});for(const s of d)(!e||s.maxv.compareTo(e)>0)&&(n===void 0?(t.push(s),n=s):ce(n,s)?s.maxv.compareTo(n.maxv)>0&&(n.maxv=s.maxv):(t.push(s),n=s));return t}function j(d,e){return{lineCount:Q.fromBytesLE(Array.prototype.slice.call(d,e,e+8),!0).toNumber()}}function P(d,e){return d?d.compareTo(e)>0?e:d:e}function de(d,e=t=>t){let t=0,n=0;const s=[],i={};for(let r=0;r<d.length;r+=1)if(!d[r]){if(n<r){let a=d.toString("utf8",n,r);a=e(a),s[t]=a,i[a]=t}n=r+1,t+=1}return{refNameToId:i,refIdToName:s}}class V{constructor({filehandle:e,renameRefSeq:t=n=>n}){this.filehandle=e,this.renameRefSeq=t}}const le=21578050;function ue(d,e){return d-d%e}function fe(d,e){return d-d%e+e}function ge(d,e){return e-=1,[[0,0],[1+(d>>26),1+(e>>26)],[9+(d>>23),9+(e>>23)],[73+(d>>20),73+(e>>20)],[585+(d>>17),585+(e>>17)],[4681+(d>>14),4681+(e>>14)]]}class I extends V{async lineCount(e,t){var n,s;return((s=(n=(await this.parse(t)).indices[e])===null||n===void 0?void 0:n.stats)===null||s===void 0?void 0:s.lineCount)||0}async _parse(e){const t=await this.filehandle.readFile(e);if(t.readUInt32LE(0)!==le)throw new Error("Not a BAI file");const n=t.readInt32LE(4),i=((1<<(5+1)*3)-1)/7;let r=8,a;const o=new Array(n);for(let h=0;h<n;h++){const c=t.readInt32LE(r);let l;r+=4;const u={};for(let g=0;g<c;g+=1){const m=t.readUInt32LE(r);if(r+=4,m===i+1)r+=4,l=j(t,r+16),r+=32;else{if(m>i+1)throw new Error("bai index contains too many bins, please use CSI");{const b=t.readInt32LE(r);r+=4;const x=new Array(b);for(let _=0;_<b;_++){const y=E(t,r);r+=8;const k=E(t,r);r+=8,a=P(a,y),x[_]=new B(y,k,m)}u[m]=x}}}const f=t.readInt32LE(r);r+=4;const p=new Array(f);for(let g=0;g<f;g++){const m=E(t,r);r+=8,a=P(a,m),p[g]=m}o[h]={binIndex:u,linearIndex:p,stats:l}}return{bai:!0,firstDataLine:a,maxBlockSize:65536,indices:o,refCount:n}}async indexCov(e,t,n,s={}){const r=t!==void 0,o=(await this.parse(s)).indices[e];if(!o)return[];const{linearIndex:h=[],stats:c}=o;if(h.length===0)return[];const l=n===void 0?(h.length-1)*16384:fe(n,16384),u=t===void 0?0:ue(t,16384),f=r?new Array((l-u)/16384):new Array(h.length-1),p=h[h.length-1].blockPosition;if(l>(h.length-1)*16384)throw new Error("query outside of range of linear index");let g=h[u/16384].blockPosition;for(let m=u/16384,b=0;m<l/16384;m++,b++)f[b]={score:h[m+1].blockPosition-g,start:m*16384,end:m*16384+16384},g=h[m+1].blockPosition;return f.map(m=>({...m,score:m.score*((c==null?void 0:c.lineCount)||0)/p}))}async blocksForRange(e,t,n,s={}){t<0&&(t=0);const i=await this.parse(s);if(!i)return[];const r=i.indices[e];if(!r)return[];const a=ge(t,n),o=[];for(const[f,p]of a)for(let g=f;g<=p;g++)if(r.binIndex[g]){const m=r.binIndex[g];for(const b of m)o.push(new B(b.minv,b.maxv,g))}const h=r.linearIndex.length;let c;const l=Math.min(t>>14,h-1),u=Math.min(n>>14,h-1);for(let f=l;f<=u;++f){const p=r.linearIndex[f];p&&(!c||p.compareTo(c)<0)&&(c=p)}return H(o,c)}async parse(e={}){return this.setupP||(this.setupP=this._parse(e).catch(t=>{throw this.setupP=void 0,t})),this.setupP}async hasRefSeq(e,t={}){var n;return!!(!((n=(await this.parse(t)).indices[e])===null||n===void 0)&&n.binIndex)}}const me=21582659,pe=38359875;function be(d,e){return d*2**e}function O(d,e){return Math.floor(d/2**e)}class T extends V{constructor(){super(...arguments),this.maxBinNumber=0,this.depth=0,this.minShift=0}async lineCount(e,t){var n,s;return((s=(n=(await this.parse(t)).indices[e])===null||n===void 0?void 0:n.stats)===null||s===void 0?void 0:s.lineCount)||0}async indexCov(){return[]}parseAuxData(e,t){const n=e.readInt32LE(t),s=n&65536?"zero-based-half-open":"1-based-closed",i={0:"generic",1:"SAM",2:"VCF"}[n&15];if(!i)throw new Error(`invalid Tabix preset format flags ${n}`);const r={ref:e.readInt32LE(t+4),start:e.readInt32LE(t+8),end:e.readInt32LE(t+12)},a=e.readInt32LE(t+16),o=a?String.fromCharCode(a):"",h=e.readInt32LE(t+20),c=e.readInt32LE(t+24);return{columnNumbers:r,coordinateType:s,metaValue:a,metaChar:o,skipLines:h,format:i,formatFlags:n,...de(e.subarray(t+28,t+28+c),this.renameRefSeq)}}async _parse(e){const t=await this.filehandle.readFile(e),n=await q(t);let s;if(n.readUInt32LE(0)===me)s=1;else if(n.readUInt32LE(0)===pe)s=2;else throw new Error("Not a CSI file");this.minShift=n.readInt32LE(4),this.depth=n.readInt32LE(8),this.maxBinNumber=((1<<(this.depth+1)*3)-1)/7;const i=n.readInt32LE(12),r=i>=30?this.parseAuxData(n,16):void 0,a=n.readInt32LE(16+i);let o=16+i+4,h;const c=new Array(a);for(let l=0;l<a;l++){const u=n.readInt32LE(o);o+=4;const f={};let p;for(let g=0;g<u;g++){const m=n.readUInt32LE(o);if(o+=4,m>this.maxBinNumber)p=j(n,o+28),o+=44;else{h=P(h,E(n,o)),o+=8;const b=n.readInt32LE(o);o+=4;const x=new Array(b);for(let _=0;_<b;_+=1){const y=E(n,o);o+=8;const k=E(n,o);o+=8,h=P(h,y),x[_]=new B(y,k,m)}f[m]=x}}c[l]={binIndex:f,stats:p}}return{csiVersion:s,firstDataLine:h,indices:c,refCount:a,csi:!0,maxBlockSize:65536,...r}}async blocksForRange(e,t,n,s={}){t<0&&(t=0);const r=(await this.parse(s)).indices[e];if(!r)return[];const a=this.reg2bins(t,n);if(a.length===0)return[];const o=[];for(const[h,c]of a)for(let l=h;l<=c;l++)if(r.binIndex[l]){const u=r.binIndex[l];for(const f of u)o.push(f)}return H(o,new G(0,0))}reg2bins(e,t){e-=1,e<1&&(e=1),t>2**50&&(t=2**34),t-=1;let n=0,s=0,i=this.minShift+this.depth*3;const r=[];for(;n<=this.depth;i-=3,s+=be(1,n*3),n+=1){const a=s+O(e,i),o=s+O(t,i);if(o-a+r.length>this.maxBinNumber)throw new Error(`query ${e}-${t} is too large for current binning scheme (shift ${this.minShift}, depth ${this.depth}), try a smaller query or a coarser index binning scheme`);r.push([a,o])}return r}async parse(e={}){return this.setupP||(this.setupP=this._parse(e).catch(t=>{throw this.setupP=void 0,t})),this.setupP}async hasRefSeq(e,t={}){var n;return!!(!((n=(await this.parse(t)).indices[e])===null||n===void 0)&&n.binIndex)}}const w={BAM_FPAIRED:1,BAM_FPROPER_PAIR:2,BAM_FUNMAP:4,BAM_FMUNMAP:8,BAM_FREVERSE:16,BAM_FMREVERSE:32,BAM_FREAD1:64,BAM_FREAD2:128,BAM_FSECONDARY:256,BAM_FQCFAIL:512,BAM_FDUP:1024,BAM_FSUPPLEMENTARY:2048},$="=ACMGRSVTWYHKDBN".split(""),v="MIDNSHP=X???????".split("");class A{constructor(e){this.bytes=e.bytes,this.fileOffset=e.fileOffset}get byteArray(){return this.bytes.byteArray}get flags(){return(this.byteArray.readInt32LE(this.bytes.start+16)&4294901760)>>16}get ref_id(){return this.byteArray.readInt32LE(this.bytes.start+4)}get start(){return this.byteArray.readInt32LE(this.bytes.start+8)}get end(){return this.start+this.length_on_ref}get id(){return this.fileOffset}get mq(){const e=(this.bin_mq_nl&65280)>>8;return e===255?void 0:e}get score(){return this.mq}get qual(){if(this.isSegmentUnmapped())return;const e=this.b0+this.read_name_length+this.num_cigar_ops*4+this.num_seq_bytes;return this.byteArray.subarray(e,e+this.seq_length)}get strand(){return this.isReverseComplemented()?-1:1}get b0(){return this.bytes.start+36}get name(){return this.byteArray.toString("ascii",this.b0,this.b0+this.read_name_length-1)}get tags(){const{byteArray:e}=this.bytes;let t=this.b0+this.read_name_length+this.num_cigar_ops*4+this.num_seq_bytes+this.seq_length;const n=this.bytes.end,s={};for(;t<n;){const i=String.fromCharCode(e[t],e[t+1]),r=String.fromCharCode(e[t+2]);if(t+=3,r==="A")s[i]=String.fromCharCode(e[t]),t+=1;else if(r==="i")s[i]=e.readInt32LE(t),t+=4;else if(r==="I")s[i]=e.readUInt32LE(t),t+=4;else if(r==="c")s[i]=e.readInt8(t),t+=1;else if(r==="C")s[i]=e.readUInt8(t),t+=1;else if(r==="s")s[i]=e.readInt16LE(t),t+=2;else if(r==="S")s[i]=e.readUInt16LE(t),t+=2;else if(r==="f")s[i]=e.readFloatLE(t),t+=4;else if(r==="Z"||r==="H"){const a=[];for(;t<=n;){const o=e[t++];if(o!==0)a.push(String.fromCharCode(o));else break}s[i]=a.join("")}else if(r==="B"){const a=e[t++],o=String.fromCharCode(a),h=e.readInt32LE(t);if(t+=4,o==="i")if(i==="CG"){const c=[];for(let l=0;l<h;l++){const u=e.readInt32LE(t),f=u>>4,p=v[u&15];c.push(f+p),t+=4}s[i]=c.join("")}else{const c=[];for(let l=0;l<h;l++)c.push(e.readInt32LE(t)),t+=4;s[i]=c}else if(o==="I")if(i==="CG"){const c=[];for(let l=0;l<h;l++){const u=e.readUInt32LE(t),f=u>>4,p=v[u&15];c.push(f+p),t+=4}s[i]=c.join("")}else{const c=[];for(let l=0;l<h;l++)c.push(e.readUInt32LE(t)),t+=4;s[i]=c}else if(o==="s"){const c=[];for(let l=0;l<h;l++)c.push(e.readInt16LE(t)),t+=2;s[i]=c}else if(o==="S"){const c=[];for(let l=0;l<h;l++)c.push(e.readUInt16LE(t)),t+=2;s[i]=c}else if(o==="c"){const c=[];for(let l=0;l<h;l++)c.push(e.readInt8(t)),t+=1;s[i]=c}else if(o==="C"){const c=[];for(let l=0;l<h;l++)c.push(e.readUInt8(t)),t+=1;s[i]=c}else if(o==="f"){const c=[];for(let l=0;l<h;l++)c.push(e.readFloatLE(t)),t+=4;s[i]=c}}else{console.error("Unknown BAM tag type",r);break}}return s}isPaired(){return!!(this.flags&w.BAM_FPAIRED)}isProperlyPaired(){return!!(this.flags&w.BAM_FPROPER_PAIR)}isSegmentUnmapped(){return!!(this.flags&w.BAM_FUNMAP)}isMateUnmapped(){return!!(this.flags&w.BAM_FMUNMAP)}isReverseComplemented(){return!!(this.flags&w.BAM_FREVERSE)}isMateReverseComplemented(){return!!(this.flags&w.BAM_FMREVERSE)}isRead1(){return!!(this.flags&w.BAM_FREAD1)}isRead2(){return!!(this.flags&w.BAM_FREAD2)}isSecondary(){return!!(this.flags&w.BAM_FSECONDARY)}isFailedQc(){return!!(this.flags&w.BAM_FQCFAIL)}isDuplicate(){return!!(this.flags&w.BAM_FDUP)}isSupplementary(){return!!(this.flags&w.BAM_FSUPPLEMENTARY)}get cigarAndLength(){if(this.isSegmentUnmapped())return{length_on_ref:0,CIGAR:""};const e=this.num_cigar_ops;let t=this.b0+this.read_name_length;const n=[];let s=this.byteArray.readInt32LE(t),i=s>>4,r=v[s&15];if(r==="S"&&i===this.seq_length)return t+=4,s=this.byteArray.readInt32LE(t),i=s>>4,r=v[s&15],r!=="N"&&console.warn("CG tag with no N tag"),{CIGAR:this.tags.CG,length_on_ref:i};{let a=0;for(let o=0;o<e;++o)s=this.byteArray.readInt32LE(t),i=s>>4,r=v[s&15],n.push(i+r),r!=="H"&&r!=="S"&&r!=="I"&&(a+=i),t+=4;return{CIGAR:n.join(""),length_on_ref:a}}}get length_on_ref(){return this.cigarAndLength.length_on_ref}get CIGAR(){return this.cigarAndLength.CIGAR}get num_cigar_ops(){return this.flag_nc&65535}get read_name_length(){return this.bin_mq_nl&255}get num_seq_bytes(){return this.seq_length+1>>1}get seq(){const{byteArray:e}=this.bytes,t=this.b0+this.read_name_length+this.num_cigar_ops*4,n=this.num_seq_bytes,s=this.seq_length,i=[];let r=0;for(let a=0;a<n;++a){const o=e[t+a];i.push($[(o&240)>>4]),r++,r<s&&(i.push($[o&15]),r++)}return i.join("")}get pair_orientation(){if(!this.isSegmentUnmapped()&&!this.isMateUnmapped()&&this.ref_id===this.next_refid){const e=this.isReverseComplemented()?"R":"F",t=this.isMateReverseComplemented()?"R":"F";let n=" ",s=" ";this.isRead1()?(n="1",s="2"):this.isRead2()&&(n="2",s="1");const i=[];return this.template_length>0?(i[0]=e,i[1]=n,i[2]=t,i[3]=s):(i[2]=e,i[3]=n,i[0]=t,i[1]=s),i.join("")}}get bin_mq_nl(){return this.byteArray.readInt32LE(this.bytes.start+12)}get flag_nc(){return this.byteArray.readInt32LE(this.bytes.start+16)}get seq_length(){return this.byteArray.readInt32LE(this.bytes.start+20)}get next_refid(){return this.byteArray.readInt32LE(this.bytes.start+24)}get next_pos(){return this.byteArray.readInt32LE(this.bytes.start+28)}get template_length(){return this.byteArray.readInt32LE(this.bytes.start+32)}toJSON(){const e={};for(const t of Object.keys(this))t.startsWith("_")||t==="bytes"||(e[t]=this[t]);return e}}function L(d,e){const t=Object.getOwnPropertyDescriptor(d.prototype,e);if(!t)throw new Error("OH NO, NO PROPERTY DESCRIPTOR");const n=t.get;if(!n)throw new Error("OH NO, NOT A GETTER");Object.defineProperty(d.prototype,e,{get(){const s=n.call(this);return Object.defineProperty(this,e,{value:s}),s}})}L(A,"tags");L(A,"cigarAndLength");L(A,"seq");L(A,"qual");function xe(d){const e=d.split(/\r?\n/),t=[];for(const n of e){const[s,...i]=n.split(/\t/);s&&t.push({tag:s.slice(1),data:i.map(r=>{const a=r.indexOf(":"),o=r.slice(0,a),h=r.slice(a+1);return{tag:o,value:h}})})}return t}const _e=21840194,U=65536;async function we(d){let e=[];for await(const t of d)e=e.concat(t);return e}class ye{read(){throw new Error("never called")}stat(){throw new Error("never called")}readFile(){throw new Error("never called")}close(){throw new Error("never called")}}class Ee{constructor({bamFilehandle:e,bamPath:t,bamUrl:n,baiPath:s,baiFilehandle:i,baiUrl:r,csiPath:a,csiFilehandle:o,csiUrl:h,htsget:c,yieldThreadTime:l=100,renameRefSeqs:u=f=>f}){if(this.htsget=!1,this.featureCache=new Y({cache:new W({maxSize:50}),fill:async(f,p)=>{const{chunk:g,opts:m}=f,{data:b,cpositions:x,dpositions:_}=await this._readChunk({chunk:g,opts:{...m,signal:p}});return this.readBamFeatures(b,x,_,g)}}),this.renameRefSeq=u,e)this.bam=e;else if(t)this.bam=new C(t);else if(n)this.bam=new S(n);else if(c)this.htsget=!0,this.bam=new ye;else throw new Error("unable to initialize bam");if(o)this.index=new T({filehandle:o});else if(a)this.index=new T({filehandle:new C(a)});else if(h)this.index=new T({filehandle:new S(h)});else if(i)this.index=new I({filehandle:i});else if(s)this.index=new I({filehandle:new C(s)});else if(r)this.index=new I({filehandle:new S(r)});else if(t)this.index=new I({filehandle:new C(`${t}.bai`)});else if(n)this.index=new I({filehandle:new S(`${n}.bai`)});else if(c)this.htsget=!0;else throw new Error("unable to infer index format");this.yieldThreadTime=l}async getHeaderPre(e){const t=he(e);if(!this.index)return;const n=await this.index.parse(t),s=n.firstDataLine?n.firstDataLine.blockPosition+65535:void 0;let i;if(s){const c=s+U,l=await this.bam.read(F.Buffer.alloc(c),0,c,0,t);if(!l.bytesRead)throw new Error("Error reading header");i=l.buffer.subarray(0,Math.min(l.bytesRead,s))}else i=await this.bam.readFile(t);const r=await q(i);if(r.readInt32LE(0)!==_e)throw new Error("Not a BAM file");const a=r.readInt32LE(4);this.header=r.toString("utf8",8,8+a);const{chrToIndex:o,indexToChr:h}=await this._readRefSeqs(a+8,65535,t);return this.chrToIndex=o,this.indexToChr=h,xe(this.header)}getHeader(e){return this.headerP||(this.headerP=this.getHeaderPre(e).catch(t=>{throw this.headerP=void 0,t})),this.headerP}async getHeaderText(e={}){return await this.getHeader(e),this.header}async _readRefSeqs(e,t,n){if(e>t)return this._readRefSeqs(e,t*2,n);const s=t+U,{bytesRead:i,buffer:r}=await this.bam.read(F.Buffer.alloc(s),0,t,0,n);if(!i)throw new Error("Error reading refseqs from header");const a=await q(r.subarray(0,Math.min(i,t))),o=a.readInt32LE(e);let h=e+4;const c={},l=[];for(let u=0;u<o;u+=1){const f=a.readInt32LE(h),p=this.renameRefSeq(a.toString("utf8",h+4,h+4+f-1)),g=a.readInt32LE(h+f+4);if(c[p]=u,l.push({refName:p,length:g}),h=h+8+f,h>a.length)return console.warn(`BAM header is very big.  Re-fetching ${t} bytes.`),this._readRefSeqs(e,t*2,n)}return{chrToIndex:c,indexToChr:l}}async getRecordsForRange(e,t,n,s){return we(this.streamRecordsForRange(e,t,n,s))}async*streamRecordsForRange(e,t,n,s){var i;await this.getHeader(s);const r=(i=this.chrToIndex)===null||i===void 0?void 0:i[e];if(r===void 0||!this.index)yield[];else{const a=await this.index.blocksForRange(r,t-1,n,s);yield*this._fetchChunkFeatures(a,r,t,n,s)}}async*_fetchChunkFeatures(e,t,n,s,i={}){const{viewAsPairs:r}=i,a=[];let o=!1;for(const h of e){const c=await this.featureCache.get(h.toString(),{chunk:h,opts:i},i.signal),l=[];for(const u of c)if(u.ref_id===t)if(u.start>=s){o=!0;break}else u.end>=n&&l.push(u);if(a.push(l),yield l,o)break}oe(i.signal),r&&(yield this.fetchPairs(t,a,i))}async fetchPairs(e,t,n){const{pairAcrossChr:s,maxInsertSize:i=2e5}=n,r={},a={};t.map(u=>{const f={};for(const p of u){const g=p.name,m=p.id;f[g]||(f[g]=0),f[g]++,a[m]=1}for(const[p,g]of Object.entries(f))g===1&&(r[p]=!0)});const o=[];t.map(u=>{for(const f of u){const p=f.name,g=f.start,m=f.next_pos,b=f.next_refid;this.index&&r[p]&&(s||b===e&&Math.abs(g-m)<i)&&o.push(this.index.blocksForRange(b,m,m+1,n))}});const h=new Map,c=await Promise.all(o);for(const u of c.flat())h.has(u.toString())||h.set(u.toString(),u);return(await Promise.all([...h.values()].map(async u=>{const{data:f,cpositions:p,dpositions:g,chunk:m}=await this._readChunk({chunk:u,opts:n}),b=[];for(const x of await this.readBamFeatures(f,p,g,m))r[x.name]&&!a[x.id]&&b.push(x);return b}))).flat()}async _readRegion(e,t,n={}){const{bytesRead:s,buffer:i}=await this.bam.read(F.Buffer.alloc(t),0,t,e,n);return i.subarray(0,Math.min(s,t))}async _readChunk({chunk:e,opts:t}){const n=await this._readRegion(e.minv.blockPosition,e.fetchedSize(),t),{buffer:s,cpositions:i,dpositions:r}=await J(n,e);return{data:s,cpositions:i,dpositions:r,chunk:e}}async readBamFeatures(e,t,n,s){let i=0;const r=[];let a=0,o=+Date.now();for(;i+4<e.length;){const h=e.readInt32LE(i),c=i+4+h-1;if(n){for(;i+s.minv.dataPosition>=n[a++];);a--}if(c<e.length){const l=new A({bytes:{byteArray:e,start:i,end:c},fileOffset:t.length>0?t[a]*256+(i-n[a])+s.minv.dataPosition+1:ne.signed(e.slice(i,c))});r.push(l),this.yieldThreadTime&&+Date.now()-o>this.yieldThreadTime&&(await ae(1),o=+Date.now())}i=c+1}return r}async hasRefSeq(e){var t,n;const s=(t=this.chrToIndex)===null||t===void 0?void 0:t[e];return s===void 0?!1:(n=this.index)===null||n===void 0?void 0:n.hasRefSeq(s)}async lineCount(e){var t;const n=(t=this.chrToIndex)===null||t===void 0?void 0:t[e];return n===void 0||!this.index?0:this.index.lineCount(n)}async indexCov(e,t,n){var s;if(!this.index)return[];await this.index.parse();const i=(s=this.chrToIndex)===null||s===void 0?void 0:s[e];return i===void 0?[]:this.index.indexCov(i,t,n)}async blocksForRange(e,t,n,s){var i;if(!this.index)return[];await this.index.parse();const r=(i=this.chrToIndex)===null||i===void 0?void 0:i[e];return r===void 0?[]:this.index.blocksForRange(r,t,n,s)}}class N{constructor(e,t,n){this.record=e,this.adapter=t,this.ref=n}id(){return`${this.adapter.id}-${this.record.id}`}get mismatches(){return X(this.record.CIGAR,this.record.tags.MD,this.record.seq,this.ref,this.record.qual)}get qual(){var e;return(e=this.record.qual)===null||e===void 0?void 0:e.join(" ")}get(e){return e==="mismatches"?this.mismatches:e==="qual"?this.qual:this.fields[e]}parent(){}children(){}get fields(){const e=this.record,t=this.adapter,n=e.isPaired();return{start:e.start,name:e.name,end:e.end,score:e.score,strand:e.strand,template_length:e.template_length,flags:e.flags,tags:e.tags,refName:t.refIdToName(e.ref_id),CIGAR:e.CIGAR,seq:e.seq,type:"match",pair_orientation:e.pair_orientation,next_ref:n?t.refIdToName(e.next_refid):void 0,next_pos:n?e.next_pos:void 0,next_segment_position:n?`${t.refIdToName(e.next_refid)}:${e.next_pos+1}`:void 0,uniqueId:this.id()}}toJSON(){return{...this.fields,qual:this.qual}}}z(N,"fields");z(N,"mismatches");class Ie extends se.BaseFeatureDataAdapter{constructor(){super(...arguments),this.ultraLongFeatureCache=new ie({maxSize:500})}async configurePre(){const e=this.getConf("bamLocation"),t=this.getConf(["index","location"]),n=this.getConf(["index","indexType"]),s=this.pluginManager,i=n==="CSI",r=new Ee({bamFilehandle:M.openLocation(e,s),csiFilehandle:i?M.openLocation(t,s):void 0,baiFilehandle:i?void 0:M.openLocation(t,s),yieldThreadTime:Number.POSITIVE_INFINITY}),a=this.getConf("sequenceAdapter");if(a&&this.getSubAdapter){const{dataAdapter:o}=await this.getSubAdapter(a);return{bam:r,sequenceAdapter:o}}return{bam:r}}async configure(){return this.configureP||(this.configureP=this.configurePre().catch(e=>{throw this.configureP=void 0,e})),this.configureP}async getHeader(e){const{bam:t}=await this.configure();return t.getHeaderText()}async setupPre(e){const{statusCallback:t=()=>{}}=e||{},{bam:n}=await this.configure();return this.samHeader=await R.updateStatus("Downloading index",t,async()=>{const s=await n.getHeader(),i=[],r={};return s==null||s.filter(a=>a.tag==="SQ").forEach((a,o)=>{const h=a.data.find(c=>c.tag==="SN");if(h){const c=h.value;r[c]=o,i[o]=c}}),{idToName:i,nameToId:r}}),this.samHeader}async setup(e){return this.setupP||(this.setupP=this.setupPre(e).catch(t=>{throw this.setupP=void 0,t})),this.setupP}async getRefNames(e){const{idToName:t}=await this.setup(e);return t}async seqFetch(e,t,n){const{sequenceAdapter:s}=await this.configure(),i=s;if(!i||!e)return;const r=i.getFeatures({refName:e,start:t,end:n,assemblyName:""}),a=await K(r.pipe(Z()));let o="";if(a.sort((h,c)=>h.get("start")-c.get("start")).forEach(h=>{const c=h.get("start"),l=h.get("end"),u=Math.max(t-c,0),p=Math.min(n-c,l-c)-u,g=h.get("seq")||h.get("residues");o+=g.slice(u,u+p)}),o.length!==n-t)throw new Error(`sequence fetch failed: fetching ${e}:${(t-1).toLocaleString()}-${n.toLocaleString()} returned ${o.length.toLocaleString()} bases, but should have returned ${(n-t).toLocaleString()}`);return o}getFeatures(e,t){const{refName:n,start:s,end:i,originalRefName:r}=e,{stopToken:a,filterBy:o,statusCallback:h=()=>{}}=t||{};return re.ObservableCreate(async c=>{const{bam:l}=await this.configure();await this.setup(t),D.checkStopToken(a);const u=await R.updateStatus("Downloading alignments",h,()=>l.getRecordsForRange(n,s,i));D.checkStopToken(a),await R.updateStatus("Processing alignments",h,async()=>{const{flagInclude:f=0,flagExclude:p=0,tagFilter:g,readName:m}=o||{};for(const b of u){let x;if(b.tags.MD||(x=await this.seqFetch(r||n,b.start,b.end)),ee(b.flags,f,p)||g&&te(b.tags[g.tag],g.value)||m&&b.name!==m)continue;const _=this.ultraLongFeatureCache.get(`${b.id}`);if(_)c.next(_);else{const y=new N(b,this,x);this.ultraLongFeatureCache.set(`${b.id}`,y),c.next(y)}}c.complete()})})}async getMultiRegionFeatureDensityStats(e,t){const{bam:n}=await this.configure();if(n.index){const s=await R.bytesForRegions(e,n),i=this.getConf("fetchSizeLimit");return{bytes:s,fetchSizeLimit:i}}return super.getMultiRegionFeatureDensityStats(e,t)}freeResources(){}refIdToName(e){var t;return(t=this.samHeader)===null||t===void 0?void 0:t.idToName[e]}}const Pe=Object.freeze(Object.defineProperty({__proto__:null,default:Ie},Symbol.toStringTag,{value:"Module"}));export{Ee as B,_e as a,Ie as b,Pe as c,xe as p};
